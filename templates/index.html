{% extends "base.html" %}

{% block title %}Главная - Vortex Cloud{% endblock %}

{% block content %}
<style>
    /* Отключаем выделение текста на странице с файлами */
    .main-content {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    /* Стили для миниатюр файлов */
    .file-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        background-size: cover;
        background-position: center;
    }
    
    .file-thumbnail:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }
    
    /* Стили для ленивой загрузки */
    .file-thumbnail[loading="lazy"] {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .file-thumbnail[loading="lazy"].loaded {
        opacity: 1;
    }
    
    /* Стили для плейсхолдеров */
    .file-thumbnail-placeholder {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        border: 2px dashed #dee2e6;
        color: #6c757d;
        font-size: 1.5rem;
    }
    
    /* Темная тема для миниатюр */
    body.dark-theme .file-thumbnail {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-theme .file-thumbnail-placeholder {
        background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        border-color: #6c757d;
        color: #adb5bd;
    }
    
    /* Разрешаем выделение только для инпутов и текстовых областей */
    input, textarea, .form-control {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    
    /* Стили для галереи изображений */
    .image-gallery-nav-btn {
        background: rgba(255, 255, 255, 0.95) !important;
        border: 2px solid rgba(0, 0, 0, 0.08) !important;
        color: #2c3e50 !important;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        font-size: 1.1rem;
        font-weight: 500;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        cursor: pointer;
        outline: none;
        position: relative;
        overflow: hidden;
    }
    
    .image-gallery-nav-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.1), rgba(155, 89, 182, 0.1));
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.25s ease;
    }
    
    .image-gallery-nav-btn:hover {
        background: rgba(255, 255, 255, 1) !important;
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: rgba(52, 152, 219, 0.3) !important;
        color: #3498db !important;
    }
    
    .image-gallery-nav-btn:hover::before {
        opacity: 1;
    }
    
    .image-gallery-nav-btn:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
    }
    
    .image-gallery-nav-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        transform: none;
        background: rgba(200, 200, 200, 0.8) !important;
        color: #999 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .image-gallery-nav-btn:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
    }
    
    /* Стили для темной темы */
    body.dark-theme .image-gallery-nav-btn {
        background: rgba(52, 58, 64, 0.95) !important;
        border-color: rgba(255, 255, 255, 0.15) !important;
        color: #e9ecef !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-theme .image-gallery-nav-btn:hover {
        background: rgba(73, 80, 87, 1) !important;
        border-color: rgba(52, 152, 219, 0.5) !important;
        color: #74b9ff !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
    }
    
    body.dark-theme .image-gallery-nav-btn::before {
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(155, 89, 182, 0.2));
    }
    
    body.dark-theme .image-counter {
        background: rgba(255, 255, 255, 0.15) !important;
        color: #e9ecef !important;
        border-color: rgba(255, 255, 255, 0.2) !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    body.dark-theme .image-container {
        background: linear-gradient(135deg, rgba(52, 58, 64, 0.3), rgba(73, 80, 87, 0.3));
    }
    
    .image-counter {
        background: rgba(0, 0, 0, 0.85) !important;
        color: white !important;
        padding: 10px 16px;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 500;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        letter-spacing: 0.5px;
    }
    
    .image-container {
        position: relative;
        min-height: 400px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: linear-gradient(135deg, rgba(248, 249, 250, 0.5), rgba(233, 236, 239, 0.5));
        border-radius: 12px;
        margin: 10px;
    }
    
    .image-container img {
        max-height: 70vh;
        max-width: 100%;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }
    
    .image-container img:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }
    
    /* Анимация для смены изображений */
    .image-fade {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .image-fade.show {
        opacity: 1;
    }
    
    /* Мобильная навигация */
    .mobile-nav-toggle {
        display: none;
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5rem;
        padding: 0.5rem;
        cursor: pointer;
    }
    
    body.dark-theme .mobile-nav-toggle {
        color: var(--text-dark);
    }
    
    /* Мобильная боковая панель */
    .mobile-sidebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1050;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    
    .mobile-sidebar-content {
        position: absolute;
        top: 0;
        left: 0;
        width: 85%;
        max-width: 350px;
        height: 100%;
        background: var(--bg-light);
        border-right: 1px solid var(--border-light);
        overflow-y: auto;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        padding: 1rem;
    }
    
    body.dark-theme .mobile-sidebar-content {
        background: var(--bg-dark);
        border-color: var(--border-dark);
    }
    
    .mobile-sidebar.show .mobile-sidebar-content {
        transform: translateX(0);
    }
    
    .mobile-sidebar-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--text-light);
        font-size: 1.5rem;
        cursor: pointer;
        z-index: 1051;
    }
    
    body.dark-theme .mobile-sidebar-close {
        color: var(--text-dark);
    }
    
    /* Адаптивные стили для мобильных устройств */
    @media (max-width: 768px) {
        .mobile-nav-toggle {
            display: block;
        }
        
        .sidebar {
            display: none;
        }
        
        .col-md-3 {
            display: none;
        }
        
        .col-md-9 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .image-gallery-nav-btn {
            width: 56px;
            height: 56px;
            font-size: 1.3rem;
            border-width: 2px;
        }
        
        .image-counter {
            font-size: 0.85rem;
            padding: 8px 14px;
            border-radius: 20px;
        }
        
        /* Мобильная оптимизация для карточек */
        .item-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .item-card h6 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        
        .item-card .text-muted {
            font-size: 0.8rem;
        }
        
        /* Мобильная оптимизация для кнопок */
        .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .btn-sm {
            padding: 0.375rem 0.5rem;
            font-size: 0.8rem;
        }
        
        /* Мобильная оптимизация для заголовков */
        h4 {
            font-size: 1.25rem;
        }
        
        h5 {
            font-size: 1.1rem;
        }
        
        h6 {
            font-size: 1rem;
        }
        
        /* Мобильная оптимизация для таблиц */
        .table-responsive {
            font-size: 0.875rem;
        }
        
        .table th,
        .table td {
            padding: 0.5rem 0.25rem;
        }
        
        /* Скрываем некоторые колонки на мобильных */
        .table th:nth-child(3),
        .table td:nth-child(3),
        .table th:nth-child(4),
        .table td:nth-child(4) {
            display: none;
        }
        
        /* Мобильная оптимизация для breadcrumb */
        .breadcrumb {
            font-size: 0.875rem;
        }
        
        .breadcrumb-item {
            margin-right: 0.25rem;
        }
        
        /* Мобильная оптимизация для статистики */
        .stats-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-number {
            font-size: 1.25rem;
        }
        
        .stats-label {
            font-size: 0.8rem;
        }
        
        /* Мобильная оптимизация для модальных окон */
        .modal-dialog {
            margin: 0.5rem;
            max-width: calc(100% - 1rem);
        }
        
        .modal-body {
            padding: 1rem;
        }
        
        .modal-footer {
            padding: 0.75rem 1rem;
        }
        
        /* Мобильная оптимизация для кнопок переключения режимов */
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            border-radius: 0.375rem !important;
            margin-bottom: 0.25rem;
        }
        
        /* Мобильная оптимизация для заголовка */
        .d-flex.justify-content-between.align-items-center {
            flex-direction: column;
            align-items: stretch !important;
            gap: 1rem;
        }
        
        .d-flex.align-items-center {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Мобильная оптимизация для кнопки возврата */
        .btn-back {
            width: 100%;
            margin-bottom: 1rem;
        }
    }
    
    /* Стили для очень маленьких экранов */
    @media (max-width: 480px) {
        .image-gallery-nav-btn {
            width: 52px;
            height: 52px;
            font-size: 1.2rem;
        }
        
        .image-counter {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .item-card {
            padding: 0.5rem;
        }
        
        .btn {
            padding: 0.375rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .modal-dialog {
            margin: 0.25rem;
            max-width: calc(100% - 0.5rem);
        }
        
        .modal-body {
            padding: 0.75rem;
        }
        
        .modal-footer {
            padding: 0.5rem 0.75rem;
        }
        
        /* Скрываем больше колонок на очень маленьких экранах */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            display: none;
        }
        
        /* Оптимизация для плиточного представления */
        .col-md-4.col-lg-3 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .item-card {
            margin-bottom: 0.5rem;
        }
    }
    
    /* Стили для планшетов */
    @media (min-width: 769px) and (max-width: 1024px) {
        .col-md-3 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
            margin-bottom: 1rem;
        }
        
        .col-md-9 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .sidebar {
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        body.dark-theme .sidebar {
            border-color: var(--border-dark);
        }
    }
    
    /* Дополнительные мобильные улучшения */
    @media (max-width: 768px) {
        /* Улучшенная мобильная навигация */
        .mobile-nav-toggle {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            transition: all 0.2s ease;
        }
        
        body.dark-theme .mobile-nav-toggle {
            background: var(--bg-dark);
            border-color: var(--border-dark);
        }
        
        .mobile-nav-toggle:hover {
            background: var(--border-light);
        }
        
        body.dark-theme .mobile-nav-toggle:hover {
            background: var(--border-dark);
        }
        
        /* Улучшенные мобильные кнопки */
        .btn {
            min-height: 44px; /* Минимальная высота для удобства касания */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn i {
            font-size: 1rem;
        }
        
        /* Улучшенная мобильная таблица */
        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .table th,
        .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        /* Улучшенные мобильные карточки */
        .item-card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .item-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }
        
        /* Улучшенная мобильная статистика */
        .stats-card {
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        /* Улучшенная мобильная боковая панель */
        .mobile-sidebar-content {
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Улучшенные мобильные модальные окна */
        .modal-content {
            border-radius: 1rem;
            margin: 0.5rem;
        }
        
        .modal-header {
            border-radius: 1rem 1rem 0 0;
        }
        
        .modal-footer {
            border-radius: 0 0 1rem 1rem;
        }
        
        /* Улучшенная мобильная галерея изображений */
        .image-container {
            min-height: 300px;
            margin: 0.5rem;
            border-radius: 0.75rem;
        }
        
        .image-gallery-nav-btn {
            min-width: 48px;
            min-height: 48px;
        }
        
        /* Улучшенная мобильная breadcrumb */
        .breadcrumb {
            background: var(--bg-light);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }
        
        body.dark-theme .breadcrumb {
            background: var(--bg-dark);
        }
        
        .breadcrumb-item a {
            color: var(--cyan-glow);
            text-decoration: none;
            font-weight: 500;
        }
        
        .breadcrumb-item a:hover {
            text-decoration: underline;
        }
    }
    
    /* Улучшения для очень маленьких экранов */
    @media (max-width: 480px) {
        .mobile-sidebar-content {
            width: 100%;
            max-width: 100%;
        }
        
        .mobile-nav-toggle {
            padding: 0.375rem 0.5rem;
            font-size: 1.25rem;
        }
        
        .btn {
            min-height: 40px;
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }
        
        .btn-sm {
            min-height: 36px;
            padding: 0.375rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .item-card {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .item-card h6 {
            font-size: 0.85rem;
        }
        
        .item-card .text-muted {
            font-size: 0.75rem;
        }
        
        .stats-card {
            padding: 0.5rem;
        }
        
        .stats-number {
            font-size: 1.1rem;
        }
        
        .stats-label {
            font-size: 0.75rem;
        }
        
        .modal-dialog {
            margin: 0.25rem;
        }
        
        .modal-content {
            border-radius: 0.75rem;
        }
        
        .modal-header {
            padding: 0.75rem 1rem;
        }
        
        .modal-body {
            padding: 0.75rem;
        }
        
        .modal-footer {
            padding: 0.5rem 0.75rem;
        }
    }
    
    /* Стили для storage bar */
    .storage-bar {
        width: 100%;
        height: 8px;
        background-color: var(--border-light);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    body.dark-theme .storage-bar {
        background-color: var(--border-dark);
    }
    
    .storage-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--cyan-glow), var(--pink-glow));
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    /* Стили для stats-card */
    .stats-card {
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        transition: all 0.2s ease;
    }
    
    body.dark-theme .stats-card {
        background: var(--bg-dark);
        border-color: var(--border-dark);
    }
    
    .stats-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--cyan-glow);
        margin-bottom: 0.25rem;
    }
    
    .stats-label {
        font-size: 0.875rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    body.dark-theme .stats-label {
        color: var(--text-dark);
    }
    
    /* Стили для sidebar */
    .sidebar {
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 0.5rem;
        padding: 1.5rem;
        height: fit-content;
        position: sticky;
        top: 1rem;
    }
    
    body.dark-theme .sidebar {
        background: var(--bg-dark);
        border-color: var(--border-dark);
    }
    
    .sidebar h5 {
        color: var(--text-light);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--cyan-glow);
    }
    
    body.dark-theme .sidebar h5 {
        color: var(--text-dark);
    }
    
    .sidebar h6 {
        color: var(--text-light);
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    body.dark-theme .sidebar h6 {
        color: var(--text-dark);
    }
    
    /* Стили для кнопки возврата */
    .btn-back {
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        color: var(--text-light);
        transition: all 0.2s ease;
    }
    
    body.dark-theme .btn-back {
        background: var(--bg-dark);
        border-color: var(--border-dark);
        color: var(--text-dark);
    }
    
    .btn-back:hover {
        background: var(--border-light);
        border-color: var(--cyan-glow);
        color: var(--text-light);
        transform: translateX(-2px);
    }
    
    body.dark-theme .btn-back:hover {
        background: var(--border-dark);
        border-color: var(--cyan-glow);
        color: var(--text-dark);
    }
    
    /* Стили для кнопок переключения режимов просмотра */
    .btn-view-toggle {
        background: transparent;
        border: 1px solid var(--border-light);
        color: var(--text-light);
        transition: all 0.2s ease;
        min-width: 80px;
    }
    
    body.dark-theme .btn-view-toggle {
        border-color: var(--border-dark);
        color: var(--text-dark);
    }
    
    .btn-view-toggle:hover {
        background: var(--border-light);
        border-color: var(--cyan-glow);
        color: var(--text-light);
    }
    
    body.dark-theme .btn-view-toggle:hover {
        background: var(--border-dark);
        border-color: var(--cyan-glow);
        color: var(--text-dark);
    }
    
    .btn-view-toggle.active {
        background: var(--cyan-glow);
        border-color: var(--cyan-glow);
        color: var(--bg-dark);
        font-weight: 600;
    }
    
    /* Стили для breadcrumb */
    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 1.5rem;
    }
    
    .breadcrumb-item {
        color: var(--text-light);
    }
    
    body.dark-theme .breadcrumb-item {
        color: var(--text-dark);
    }
    
    .breadcrumb-item a {
        color: var(--cyan-glow);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }
    
    .breadcrumb-item a:hover {
        color: var(--pink-glow);
        text-decoration: underline;
    }
    
    .breadcrumb-item.active {
        color: var(--text-light);
        font-weight: 600;
    }
    
    body.dark-theme .breadcrumb-item.active {
        color: var(--text-dark);
    }
    
    /* Стили для карточек элементов */
    .item-card {
        border: 1px solid var(--border-light);
        border-radius: 0.75rem;
        padding: 1rem;
        background: var(--bg-light);
        transition: all 0.2s ease;
        height: 100%;
        cursor: pointer;
        width: 100%;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    body.dark-theme .item-card {
        background: var(--bg-dark);
        border-color: var(--border-dark);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .item-card:hover {
        border-color: var(--cyan-glow);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    body.dark-theme .item-card:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }
    
    .item-card:active {
        transform: translateY(0) scale(0.98);
        transition: all 0.1s ease;
    }
    
    /* Стили для текста в плитках */
    .item-card h6 {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        margin-bottom: 0.25rem;
        width: 100%;
        min-width: 0;
        color: var(--text-light);
        font-weight: 600;
    }
    
    body.dark-theme .item-card h6 {
        color: var(--text-dark);
    }
    
    .item-card .text-muted {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        font-size: 0.875rem;
        width: 100%;
        min-width: 0;
        color: var(--inactive);
    }
    
    .item-card .flex-grow-1 {
        min-width: 0;
        overflow: hidden;
    }
    
    .folder-item {
        border-left: 4px solid var(--golden-glow);
    }
    
    .file-item {
        border-left: 4px solid var(--cyan-glow);
    }
    
    /* Стили для табличного представления */
    .table th {
        background-color: var(--bg-light);
        border-top: none;
        font-weight: 600;
        color: var(--text-light);
        border-bottom: 2px solid var(--cyan-glow);
        padding: 0.75rem 0.5rem;
    }
    
    body.dark-theme .table th {
        background-color: var(--bg-dark);
        color: var(--text-dark);
        border-bottom-color: var(--cyan-glow);
    }
    
    .table td {
        vertical-align: middle;
        color: var(--text-light);
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid var(--border-light);
    }
    
    body.dark-theme .table td {
        color: var(--text-dark);
        border-bottom-color: var(--border-dark);
    }
    
    .table tbody tr:hover {
        background-color: rgba(93, 230, 225, 0.1);
    }
    
    body.dark-theme .table tbody tr:hover {
        background-color: rgba(93, 230, 225, 0.2);
    }
    
    /* Стили для badge в таблицах */
    .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
        border-radius: 0.375rem;
    }
    
    .badge.bg-success {
        background-color: var(--cyan-glow) !important;
        color: var(--bg-dark) !important;
    }
    
    .badge.bg-warning {
        background-color: var(--golden-glow) !important;
        color: var(--bg-dark) !important;
    }
    
    .badge.bg-danger {
        background-color: var(--pink-glow) !important;
        color: var(--bg-dark) !important;
    }
    
    .badge.bg-info {
        background-color: var(--cyan-glow) !important;
        color: var(--bg-dark) !important;
    }
    
    .badge.bg-primary {
        background-color: var(--cyan-glow) !important;
        color: var(--bg-dark) !important;
    }
    
    .badge.bg-secondary {
        background-color: var(--inactive) !important;
        color: var(--bg-dark) !important;
    }
    
    /* Стили для контекстного меню */
    .context-menu {
        position: fixed;
        background: var(--bg-light);
        border: 1px solid var(--border-light);
        border-radius: 0.75rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 200px;
        padding: 0.5rem 0;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    body.dark-theme .context-menu {
        background: var(--bg-dark);
        border-color: var(--border-dark);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .context-menu-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    body.dark-theme .context-menu-item {
        color: var(--text-dark);
    }
    
    .context-menu-item:hover {
        background-color: var(--cyan-glow);
        color: var(--bg-dark);
        transform: translateX(4px);
    }
    
    .context-menu-item:active {
        transform: translateX(4px) scale(0.98);
    }
    
    .context-menu-divider {
        height: 1px;
        background-color: var(--border-light);
        margin: 0.5rem 0;
    }
    
    body.dark-theme .context-menu-divider {
        background-color: var(--border-dark);
    }
    
    .context-menu-item.text-danger:hover {
        background-color: var(--pink-glow);
        color: var(--bg-dark);
    }
    
    .context-menu-item.text-warning:hover {
        background-color: var(--golden-glow);
        color: var(--bg-dark);
    }
    
    /* Стили для модальных окон */
    .modal-content {
        background: var(--bg-light);
        color: var(--text-light);
        border: 1px solid var(--border-light);
        border-radius: 1rem;
        box-shadow: 0 16px 64px rgba(0, 0, 0, 0.2);
    }
    
    body.dark-theme .modal-content {
        background: var(--bg-dark);
        color: var(--text-dark);
        border-color: var(--border-dark);
        box-shadow: 0 16px 64px rgba(0, 0, 0, 0.4);
    }
    
    .modal-header {
        border-bottom: 1px solid var(--border-light);
        border-radius: 1rem 1rem 0 0;
        background: linear-gradient(135deg, var(--bg-light), var(--border-light));
    }
    
    body.dark-theme .modal-header {
        border-bottom-color: var(--border-dark);
        background: linear-gradient(135deg, var(--bg-dark), var(--border-dark));
    }
    
    .modal-footer {
        border-top: 1px solid var(--border-light);
        border-radius: 0 0 1rem 1rem;
        background: linear-gradient(135deg, var(--border-light), var(--bg-light));
    }
    
    body.dark-theme .modal-footer {
        border-top-color: var(--border-dark);
        background: linear-gradient(135deg, var(--border-dark), var(--bg-dark));
    }
    
    .modal-title {
        color: var(--text-light);
        font-weight: 600;
    }
    
    body.dark-theme .modal-title {
        color: var(--text-dark);
    }
    
    .btn-close {
        filter: invert(1);
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    
    .btn-close:hover {
        opacity: 1;
    }
    
    body.dark-theme .btn-close {
        filter: invert(0);
    }
    
    /* Стили для алертов */
    .alert {
        border: 1px solid var(--border-light);
        border-radius: 0.75rem;
        background: var(--bg-light);
        color: var(--text-light);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    body.dark-theme .alert {
        border-color: var(--border-dark);
        background: var(--bg-dark);
        color: var(--text-dark);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .alert-warning {
        border-left: 4px solid var(--golden-glow);
        background: linear-gradient(135deg, rgba(255, 230, 133, 0.1), rgba(255, 230, 133, 0.05));
    }
    
    .alert-danger {
        border-left: 4px solid var(--pink-glow);
        background: linear-gradient(135deg, rgba(255, 119, 200, 0.1), rgba(255, 119, 200, 0.05));
    }
    
    .alert-info {
        border-left: 4px solid var(--cyan-glow);
        background: linear-gradient(135deg, rgba(93, 230, 225, 0.1), rgba(93, 230, 225, 0.05));
    }
    
    /* Улучшенная мобильная оптимизация для touch устройств */
    @media (hover: none) and (pointer: coarse) {
        .item-card:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .item-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }
        
        .btn:hover {
            transform: none;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .context-menu-item:hover {
            transform: none;
            background-color: var(--cyan-glow);
            color: var(--bg-dark);
        }
        
        .context-menu-item:active {
            transform: scale(0.98);
        }
    }
    
    /* Улучшения для устройств с высоким DPI */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .item-card {
            border-width: 0.5px;
        }
        
        .table th,
        .table td {
            border-width: 0.5px;
        }
        
        .modal-content {
            border-width: 0.5px;
        }
    }
    
    /* Дополнительные улучшения для мобильных устройств */
    @media (max-width: 768px) {
        /* Улучшенная мобильная навигация */
        .mobile-nav-toggle {
            position: relative;
            overflow: hidden;
        }
        
        .mobile-nav-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(93, 230, 225, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .mobile-nav-toggle:active::before {
            left: 100%;
        }
        
        /* Улучшенная мобильная боковая панель */
        .mobile-sidebar {
            transition: opacity 0.3s ease;
        }
        
        .mobile-sidebar.show {
            opacity: 1;
        }
        
        .mobile-sidebar:not(.show) {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Улучшенные мобильные кнопки действий */
        .d-flex.align-items-center .btn {
            flex: 1;
            margin: 0.25rem 0;
        }
        
        /* Улучшенная мобильная таблица */
        .table-responsive {
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
        }
        
        body.dark-theme .table-responsive {
            border-color: var(--border-dark);
        }
        
        /* Улучшенная мобильная статистика */
        .stats-card {
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--cyan-glow), var(--pink-glow));
        }
        
        /* Улучшенная мобильная breadcrumb */
        .breadcrumb {
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .breadcrumb-item {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Улучшенные мобильные модальные окна */
        .modal-dialog {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Улучшенная мобильная галерея */
        .image-container {
            position: relative;
        }
        
        .image-gallery-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
        }
        
        .image-gallery-nav-btn:first-child {
            left: 0.5rem;
        }
        
        .image-gallery-nav-btn:last-child {
            right: 0.5rem;
        }
        
        /* Улучшенная мобильная навигация для очень маленьких экранов */
        .mobile-nav-toggle {
            min-width: 44px;
            min-height: 44px;
        }
        
        /* Улучшенная мобильная боковая панель для очень маленьких экранов */
        .mobile-sidebar-content {
            padding: 0.75rem;
        }
        
        /* Улучшенные мобильные кнопки для очень маленьких экранов */
        .btn {
            min-width: 44px;
            min-height: 44px;
        }
        
        /* Улучшенная мобильная таблица для очень маленьких экранов */
        .table th,
        .table td {
            padding: 0.375rem 0.25rem;
            font-size: 0.8rem;
        }
        
        /* Улучшенная мобильная статистика для очень маленьких экранов */
        .stats-card {
            padding: 0.5rem;
        }
        
        .stats-number {
            font-size: 1.1rem;
        }
        
        .stats-label {
            font-size: 0.7rem;
        }
        
        /* Улучшенная мобильная breadcrumb для очень маленьких экранов */
        .breadcrumb {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }
        
        /* Улучшенные мобильные модальные окна для очень маленьких экранов */
        .modal-dialog {
            margin: 0.25rem;
            max-width: calc(100% - 0.5rem);
        }
        
        .modal-content {
            border-radius: 0.75rem;
        }
        
        .modal-header {
            padding: 0.75rem 1rem;
        }
        
        .modal-body {
            padding: 0.75rem;
        }
        
        .modal-footer {
            padding: 0.5rem 0.75rem;
        }
        
        /* Улучшенная мобильная галерея для очень маленьких экранов */
        .image-container {
            min-height: 250px;
            margin: 0.25rem;
        }
        
        .image-gallery-nav-btn {
            min-width: 44px;
            min-height: 44px;
            font-size: 1rem;
        }
        
        .image-counter {
            font-size: 0.75rem;
            padding: 0.375rem 0.75rem;
        }
    }
    
    /* Улучшения для планшетов */
    @media (min-width: 769px) and (max-width: 1024px) {
        .mobile-nav-toggle {
            display: none;
        }
        
        .sidebar {
            position: static;
            margin-bottom: 1rem;
        }
        
        .col-md-3 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .col-md-9 {
            width: 100%;
            max-width: 100%;
            flex: 0 0 100%;
        }
        
        .item-card {
            margin-bottom: 1rem;
        }
        
        .table-responsive {
            border: 1px solid var(--border-light);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        body.dark-theme .table-responsive {
            border-color: var(--border-dark);
        }
    }
    
    /* Дополнительные улучшения для всех устройств */
    .main-content {
        position: relative;
        z-index: 1;
    }
    
    /* Улучшения для accessibility */
    .btn:focus,
    .item-card:focus,
    .context-menu-item:focus {
        outline: 2px solid var(--cyan-glow);
        outline-offset: 2px;
    }
    
    /* Улучшения для печати */
    @media print {
        .mobile-nav-toggle,
        .mobile-sidebar,
        .sidebar,
        .btn-group,
        .context-menu {
            display: none !important;
        }
        
        .col-md-9 {
            width: 100% !important;
            max-width: 100% !important;
            flex: 0 0 100% !important;
        }
        
        .item-card {
            break-inside: avoid;
            border: 1px solid #000;
            margin-bottom: 1rem;
        }
        
        .table {
            border-collapse: collapse;
        }
        
        .table th,
        .table td {
            border: 1px solid #000;
            padding: 0.5rem;
        }
    }
    
    /* Улучшения для loading states */
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid var(--cyan-glow);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Улучшения для empty states */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--inactive);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state h5 {
        margin-bottom: 1rem;
        color: var(--text-light);
    }
    
    body.dark-theme .empty-state h5 {
        color: var(--text-dark);
    }
    
    .empty-state p {
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }
    
    /* Улучшения для drag and drop */
    .drag-over {
        border-color: var(--cyan-glow) !important;
        background-color: rgba(93, 230, 225, 0.1) !important;
        transform: scale(1.02);
        box-shadow: 0 8px 32px rgba(93, 230, 225, 0.2);
    }
    
    .dragging {
        opacity: 0.5;
        transform: rotate(5deg) scale(0.95);
        z-index: 1000;
    }
    
    /* Улучшения для focus states */
    .item-card:focus-within {
        border-color: var(--cyan-glow);
        box-shadow: 0 0 0 3px rgba(93, 230, 225, 0.3);
    }
    
    /* Улучшения для hover states на устройствах с поддержкой hover */
    @media (hover: hover) {
        .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        
        .context-menu-item:hover {
            transform: translateX(4px);
        }
    }
    
    /* Улучшения для анимаций */
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .slide-in-left {
        animation: slideInLeft 0.3s ease-out;
    }
    
    @keyframes slideInLeft {
        from { transform: translateX(-100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .slide-in-right {
        animation: slideInRight 0.3s ease-out;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Улучшения для transitions */
    .smooth-transition {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Улучшения для responsive images */
    .responsive-image {
        max-width: 100%;
        height: auto;
        display: block;
    }
    
    /* Улучшения для text truncation */
    .text-truncate-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .text-truncate-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Улучшения для scrollbars */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--border-light);
        border-radius: 4px;
    }
    
    body.dark-theme ::-webkit-scrollbar-track {
        background: var(--border-dark);
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--cyan-glow);
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--pink-glow);
    }
    
    /* Улучшения для selection */
    ::selection {
        background: var(--cyan-glow);
        color: var(--bg-dark);
    }
    
    ::-moz-selection {
        background: var(--cyan-glow);
        color: var(--bg-dark);
    }
    
    /* Финальные улучшения для мобильных устройств */
    @media (max-width: 768px) {
        /* Улучшенная мобильная навигация */
        .mobile-nav-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1060;
            background: var(--bg-light);
            border: 2px solid var(--cyan-glow);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(93, 230, 225, 0.3);
            transition: all 0.3s ease;
        }
        
        body.dark-theme .mobile-nav-toggle {
            background: var(--bg-dark);
        }
        
        .mobile-nav-toggle:active {
            transform: scale(0.9);
            box-shadow: 0 2px 8px rgba(93, 230, 225, 0.2);
        }
        
        /* Улучшенная мобильная боковая панель */
        .mobile-sidebar {
            z-index: 1055;
        }
        
        .mobile-sidebar-content {
            box-shadow: 8px 0 32px rgba(0, 0, 0, 0.4);
        }
        
        /* Улучшенная мобильная статистика */
        .stats-card {
            background: linear-gradient(135deg, var(--bg-light), var(--border-light));
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        body.dark-theme .stats-card {
            background: linear-gradient(135deg, var(--bg-dark), var(--border-dark));
        }
        
        /* Улучшенная мобильная таблица */
        .table-responsive {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        /* Улучшенная мобильная breadcrumb */
        .breadcrumb {
            background: linear-gradient(135deg, var(--bg-light), var(--border-light));
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        body.dark-theme .breadcrumb {
            background: linear-gradient(135deg, var(--bg-dark), var(--border-dark));
            border-color: var(--border-dark);
        }
        
        /* Улучшенные мобильные кнопки */
        .btn {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--cyan-glow), var(--pink-glow));
            border-color: transparent;
        }
        
        .btn-outline-primary {
            border-color: var(--cyan-glow);
            color: var(--cyan-glow);
        }
        
        .btn-outline-primary:active {
            background: var(--cyan-glow);
            color: var(--bg-dark);
        }
    }
</style>

<!-- Мобильная навигация -->
<div class="d-md-none mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <button class="mobile-nav-toggle" onclick="toggleMobileSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <h5 class="mb-0">Vortex Cloud</h5>
        <div class="d-flex align-items-center">
            <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-upload"></i>
            </a>
            <a href="{{ url_for('create_folder') }}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-folder-plus"></i>
            </a>
        </div>
    </div>
</div>

<!-- Мобильная боковая панель -->
<div class="mobile-sidebar" id="mobileSidebar">
    <div class="mobile-sidebar-content">
        <button class="mobile-sidebar-close" onclick="toggleMobileSidebar()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="mb-4">
            <h5 class="mb-3">
                <i class="fas fa-user me-2"></i>{{ current_user.username }}
            </h5>
            
            <!-- Storage Usage -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Использовано хранилища</span>
                    <span class="small text-muted">{{ current_user.get_storage_usage_mb() }} / {{ current_user.get_storage_limit_mb() }} МБ</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ current_user.get_storage_percentage() }}%"></div>
                </div>
                <div class="text-center mt-2">
                    <span class="badge bg-{{ 'success' if current_user.get_storage_percentage() < 80 else 'warning' if current_user.get_storage_percentage() < 95 else 'danger' }}">
                        {{ current_user.get_storage_percentage() }}%
                    </span>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mb-4">
                <h6 class="mb-3">Быстрые действия</h6>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-upload me-2"></i>Загрузить файл
                    </a>
                    <a href="{{ url_for('create_folder') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-folder-plus me-2"></i>Создать папку
                    </a>
                    <a href="{{ url_for('search') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-search me-2"></i>Поиск
                    </a>
                </div>
            </div>
            
            <!-- Statistics -->
            <div>
                <h6 class="mb-3">Статистика</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-number">{{ folders|length }}</div>
                            <div class="stats-label">Папки</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-number">{{ files|length }}</div>
                            <div class="stats-label">Файлы</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 d-none d-md-block">
        <div class="sidebar">
            <h5 class="mb-3">
                <i class="fas fa-user me-2"></i>{{ current_user.username }}
            </h5>
            
            <!-- Storage Usage -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small text-muted">Использовано хранилища</span>
                    <span class="small text-muted">{{ current_user.get_storage_usage_mb() }} / {{ current_user.get_storage_limit_mb() }} МБ</span>
                </div>
                <div class="storage-bar">
                    <div class="storage-fill" style="width: {{ current_user.get_storage_percentage() }}%"></div>
                </div>
                <div class="text-center mt-2">
                    <span class="badge bg-{{ 'success' if current_user.get_storage_percentage() < 80 else 'warning' if current_user.get_storage_percentage() < 95 else 'danger' }}">
                        {{ current_user.get_storage_percentage() }}%
                    </span>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mb-4">
                <h6 class="mb-3">Быстрые действия</h6>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('upload_file') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-upload me-2"></i>Загрузить файл
                    </a>
                    <a href="{{ url_for('create_folder') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-folder-plus me-2"></i>Создать папку
                    </a>
                    <a href="{{ url_for('search') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-search me-2"></i>Поиск
                    </a>
                </div>
            </div>
            
            <!-- Statistics -->
            <div>
                <h6 class="mb-3">Статистика</h6>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-number">{{ folders|length }}</div>
                            <div class="stats-label">Папки</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stats-card">
                            <div class="stats-number">{{ files|length }}</div>
                            <div class="stats-label">Файлы</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        <div class="main-content">
            <!-- Breadcrumb -->
            {% if breadcrumb %}
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>Главная
                        </a>
                    </li>
                    {% for folder in breadcrumb %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('index', folder=folder.id) }}">{{ folder.name }}</a>
                    </li>
                    {% endfor %}
                </ol>
            </nav>
            {% endif %}
            
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">
                    {% if current_folder_id == 0 %}
                        <i class="fas fa-home me-2"></i>Мои файлы
                    {% else %}
                        <i class="fas fa-folder me-2"></i>{{ breadcrumb[-1].name if breadcrumb else 'Папка' }}
                    {% endif %}
                </h4>
                <div class="d-flex align-items-center">
                    <!-- View Mode Toggle -->
                    <div class="btn-group btn-group-sm me-3" role="group" aria-label="Режим отображения">
                        <button type="button" class="btn btn-view-toggle" id="tileView" onclick="setViewMode('tile')">
                            <i class="fas fa-th-large me-1"></i>Плитка
                        </button>
                        <button type="button" class="btn btn-view-toggle" id="tableView" onclick="setViewMode('table')">
                            <i class="fas fa-list me-1"></i>Таблица
                        </button>
                    </div>
                    <a href="{{ url_for('upload_file', folder=current_folder_id) }}" class="btn btn-primary me-2">
                        <i class="fas fa-upload me-1"></i>Загрузить
                    </a>
                    <a href="{{ url_for('create_folder', parent=current_folder_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-folder-plus me-1"></i>Новая папка
                    </a>
                </div>
            </div>
            
            <!-- Back Button -->
            {% if breadcrumb %}
            <div class="mb-3">
                <a href="{{ url_for('index', folder=breadcrumb[-2].id if breadcrumb|length > 1 else 0) }}" class="btn btn-back btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Назад
                </a>
            </div>
            {% endif %}
            


            <!-- Combined Files and Folders List -->
            {% if folders or files %}
            <div id="fileList">
                <!-- Tile View -->
                <div id="tileViewContent" class="view-content">
                    <div class="row">
                        <!-- Корневая папка для перетаскивания -->

                        {% for folder in folders %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="item-card folder-item" 
                                 ondblclick="openFolder({{ folder.id }})"
                                 oncontextmenu="showContextMenu(event, 'folder', {{ folder.id }}, '{{ folder.name }}')"
                                 style="cursor: pointer;"
                                 title="Двойной клик для открытия папки, правый клик для меню">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="file-thumbnail-placeholder">
                                        <i class="fas fa-folder text-warning"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ folder.name }}</h6>
                                </div>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                        
                        {% for file in files %}
                        <div class="col-md-4 col-lg-3 mb-3">
                            <div class="item-card file-item" 
                                 data-file-id="{{ file.id }}"
                                 data-file-name="{{ file.original_filename }}"
                                 data-file-size="{{ file.get_file_size_formatted() }}"
                                 data-mime-type="{{ file.mime_type }}"
                                 oncontextmenu="showContextMenu(event, 'file', {{ file.id }}, '{{ file.original_filename }}', '{{ file.public_url if file.public_url else '' }}')"
                                 ondblclick="{% if file.mime_type.startswith('image/') %}openImageViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('application/pdf') %}openPdfViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('application/vnd.openxmlformats') or file.mime_type.startswith('application/vnd.ms-') %}openDocumentViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('text/') %}openTextViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% else %}window.location.href='/file/{{ file.id }}'{% endif %}"
                                 title="{% if file.mime_type.startswith('image/') %}Двойной клик для просмотра, правый клик для меню{% elif file.mime_type.startswith('application/pdf') %}Двойной клик для просмотра PDF, правый клик для меню{% elif file.mime_type.startswith('application/vnd.openxmlformats') or file.mime_type.startswith('application/vnd.ms-') %}Двойной клик для информации о документе, правый клик для меню{% elif file.mime_type.startswith('text/') %}Двойной клик для просмотра текста, правый клик для меню{% else %}Правый клик для меню действий{% endif %}">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    {% if file.mime_type.startswith('image/') %}
                                        <img src="/thumbnail/{{ file.id }}" alt="{{ file.original_filename }}" class="file-thumbnail" 
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                             loading="lazy">
                                        <div class="file-thumbnail-placeholder" style="display: none;">
                                            <i class="fas fa-image text-success"></i>
                                        </div>
                                    {% elif file.mime_type.startswith('video/') %}
                                        <div class="file-thumbnail-placeholder">
                                            <i class="fas fa-video text-danger"></i>
                                        </div>
                                    {% elif file.mime_type.startswith('audio/') %}
                                        <div class="file-thumbnail-placeholder">
                                            <i class="fas fa-music text-info"></i>
                                        </div>
                                    {% elif file.mime_type.startswith('text/') %}
                                        <div class="file-thumbnail-placeholder">
                                            <i class="fas fa-file-alt text-primary"></i>
                                        </div>
                                    {% else %}
                                        <div class="file-thumbnail-placeholder">
                                            <i class="fas fa-file text-secondary"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1" title="{{ file.original_filename }}">
                                        {{ file.original_filename[:20] }}{% if file.original_filename|length > 20 %}...{% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        {{ file.get_file_size_formatted() }}
                                    </small>
                                    {% if file.is_public %}
                                    <div class="mt-1">
                                        <span class="badge bg-success">
                                            <i class="fas fa-globe me-1"></i>Публичный
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Table View -->
                <div id="tableViewContent" class="view-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 60px;"></th>
                                    <th>Название</th>
                                    <th>Тип</th>
                                    <th>Размер</th>
                                    <th>Дата создания</th>
                                </tr>
                            </thead>
                            <tbody>

                                
                                {% for folder in folders %}
                                <tr class="folder-item" 
                                    ondblclick="openFolder({{ folder.id }})" 
                                    oncontextmenu="showContextMenu(event, 'folder', {{ folder.id }}, '{{ folder.name }}')"
                                    style="cursor: pointer;"
                                    title="Двойной клик для открытия папки, правый клик для меню">
                                    <td>
                                        <div class="file-thumbnail-placeholder">
                                            <i class="fas fa-folder text-warning"></i>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span>{{ folder.name }}</span>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-warning">Папка</span></td>
                                    <td>-</td>
                                    <td>{{ folder.created_at.strftime('%d.%m.%Y') }}</td>
                                </tr>
                                {% endfor %}
                                
                                {% for file in files %}
                                <tr data-file-id="{{ file.id }}"
                                    data-file-name="{{ file.original_filename }}"
                                    data-file-size="{{ file.get_file_size_formatted() }}"
                                    data-mime-type="{{ file.mime_type }}"
                                    oncontextmenu="showContextMenu(event, 'file', {{ file.id }}, '{{ file.original_filename }}', '{{ file.public_url if file.public_url else '' }}')"
                                    ondblclick="{% if file.mime_type.startswith('image/') %}openImageViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('application/pdf') %}openPdfViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('application/vnd.openxmlformats') or file.mime_type.startswith('application/vnd.ms-') %}openDocumentViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% elif file.mime_type.startswith('text/') %}openTextViewer({{ file.id }}, '{{ file.original_filename }}', '{{ file.get_file_size_formatted() }}'){% else %}window.location.href='/file/{{ file.id }}'{% endif %}"
                                    title="{% if file.mime_type.startswith('image/') %}Двойной клик для просмотра, правый клик для меню{% elif file.mime_type.startswith('application/pdf') %}Двойной клик для просмотра PDF, правый клик для меню{% elif file.mime_type.startswith('application/vnd.openxmlformats') or file.mime_type.startswith('application/vnd.ms-') %}Двойной клик для информации о документе, правый клик для меню{% elif file.mime_type.startswith('text/') %}Двойной клик для просмотра текста, правый клик для меню{% else %}Правый клик для меню действий{% endif %}"
                                    style="cursor: pointer;">
                                    <td>
                                        {% if file.mime_type.startswith('image/') %}
                                            <img src="/thumbnail/{{ file.id }}" alt="{{ file.original_filename }}" class="file-thumbnail" 
                                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                                 loading="lazy">
                                            <div class="file-thumbnail-placeholder" style="display: none;">
                                                <i class="fas fa-image text-success"></i>
                                            </div>
                                        {% elif file.mime_type.startswith('video/') %}
                                            <div class="file-thumbnail-placeholder">
                                                <i class="fas fa-video text-danger"></i>
                                            </div>
                                        {% elif file.mime_type.startswith('audio/') %}
                                            <div class="file-thumbnail-placeholder">
                                                <i class="fas fa-music text-info"></i>
                                            </div>
                                        {% elif file.mime_type.startswith('text/') %}
                                            <div class="file-thumbnail-placeholder">
                                                <i class="fas fa-file-alt text-primary"></i>
                                            </div>
                                        {% else %}
                                            <div class="file-thumbnail-placeholder">
                                                <i class="fas fa-file text-secondary"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span title="{{ file.original_filename }}">{{ file.original_filename }}</span>
                                            {% if file.is_public %}
                                                <span class="badge bg-success ms-2">
                                                    <i class="fas fa-globe me-1"></i>Публичный
                                                </span>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if file.mime_type.startswith('image/') %}
                                            <span class="badge bg-success">Изображение</span>
                                        {% elif file.mime_type.startswith('video/') %}
                                            <span class="badge bg-danger">Видео</span>
                                        {% elif file.mime_type.startswith('audio/') %}
                                            <span class="badge bg-info">Аудио</span>
                                        {% elif file.mime_type.startswith('text/') %}
                                            <span class="badge bg-primary">Текст</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Файл</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ file.get_file_size_formatted() }}</td>
                                    <td>{{ file.created_at.strftime('%d.%m.%Y') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Empty State -->
            <div class="text-center py-5">
                <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">Папка пуста</h5>
                <p class="text-muted">Загрузите файлы или создайте папки для начала работы</p>
                <div class="mt-3">
                    <a href="{{ url_for('upload_file', folder=current_folder_id) }}" class="btn btn-primary me-2">
                        <i class="fas fa-upload me-1"></i>Загрузить файл
                    </a>
                    <a href="{{ url_for('create_folder', parent=current_folder_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-folder-plus me-1"></i>Создать папку
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu" style="display: none;">
    <div class="context-menu-item" id="contextOpen">
        <i class="fas fa-folder-open me-2"></i>Открыть
    </div>
    <div class="context-menu-item" id="contextView">
        <i class="fas fa-eye me-2"></i>Просмотр
    </div>
    <div class="context-menu-item" id="contextDownload">
        <i class="fas fa-download me-2"></i>Скачать
    </div>
    <div class="context-menu-item" id="contextPublicLink">
        <i class="fas fa-external-link-alt me-2"></i>Публичная ссылка
    </div>
    <div class="context-menu-item" id="contextTogglePublic">
        <i class="fas fa-globe me-2"></i>Сделать публичным
    </div>
    <div class="context-menu-item" id="contextRename">
        <i class="fas fa-edit me-2"></i>Переименовать
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item text-danger" id="contextDelete">
        <i class="fas fa-trash me-2"></i>Удалить
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1" aria-labelledby="imageViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewerModalLabel">
                    <i class="fas fa-image me-2"></i>Просмотр изображения
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center position-relative">
                <!-- Навигационные кнопки -->
                <button type="button" class="btn image-gallery-nav-btn position-absolute" id="prevImageBtn" style="left: 10px; top: 50%; transform: translateY(-50%); z-index: 1000; display: none;">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button type="button" class="btn image-gallery-nav-btn position-absolute" id="nextImageBtn" style="right: 10px; top: 50%; transform: translateY(-50%); z-index: 1000; display: none;">
                    <i class="fas fa-chevron-right"></i>
                </button>
                
                <!-- Счетчик изображений -->
                <div class="position-absolute" style="top: 10px; right: 10px; z-index: 1000;">
                    <span class="badge image-counter" id="imageCounter">1 / 1</span>
                </div>
                
                <div class="image-container">
                    <img id="imageViewerImg" src="" alt="Изображение" class="img-fluid image-fade" style="max-height: 70vh; max-width: 100%;">
                </div>
                <div class="image-info mt-3">
                    <p class="text-muted mb-1" id="imageFileName"></p>
                    <p class="text-muted mb-0" id="imageFileSize"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" class="btn btn-primary" id="downloadImageBtn" target="_blank">
                    <i class="fas fa-download me-1"></i>Скачать
                </a>
            </div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div class="modal fade" id="pdfViewerModal" tabindex="-1" aria-labelledby="pdfViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pdfViewerModalLabel">
                    <i class="fas fa-file-pdf me-2"></i>Просмотр PDF
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="pdf-container">
                    <iframe id="pdfViewerFrame" src="" width="100%" height="85vh" frameborder="0"></iframe>
                </div>
                <div class="pdf-info mt-3 text-center">
                    <p class="text-muted mb-1" id="pdfFileName"></p>
                    <p class="text-muted mb-0" id="pdfFileSize"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" class="btn btn-primary" id="downloadPdfBtn" target="_blank">
                    <i class="fas fa-download me-1"></i>Скачать
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="documentViewerModal" tabindex="-1" aria-labelledby="documentViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentViewerModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Просмотр документа
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="document-container">
                    <iframe id="documentViewerFrame" src="" width="100%" height="70vh" frameborder="0" style="display: none;"></iframe>
                </div>
                <div class="document-info mt-3 text-center">
                    <p class="text-muted mb-1" id="documentFileName"></p>
                    <p class="text-muted mb-0" id="documentFileSize"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" class="btn btn-primary" id="downloadDocumentBtn" target="_blank">
                    <i class="fas fa-download me-1"></i>Скачать
                </a>
                <a href="#" class="btn btn-outline-primary" id="openDocumentBtn" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>Открыть в новом окне
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Text Viewer Modal -->
<div class="modal fade" id="textViewerModal" tabindex="-1" aria-labelledby="textViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="textViewerModalLabel">
                    <i class="fas fa-file-alt me-2"></i>Просмотр текста
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-container">
                    <pre id="textViewerContent" class="text-content"></pre>
                </div>
                <div class="text-info mt-3 text-center">
                    <p class="text-muted mb-1" id="textFileName"></p>
                    <p class="text-muted mb-0" id="textFileSize"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" class="btn btn-primary" id="downloadTextBtn" target="_blank">
                    <i class="fas fa-download me-1"></i>Скачать
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Public Link Modal -->
<div class="modal fade" id="publicLinkModal" tabindex="-1" aria-labelledby="publicLinkModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="publicLinkModalLabel">
                    <i class="fas fa-globe me-2"></i>Публичная ссылка
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Скопируйте эту ссылку, чтобы поделиться файлом с другими людьми:</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="publicLinkInput" readonly>
                    <button class="btn btn-outline-primary" type="button" onclick="copyPublicLink()">
                        <i class="fas fa-copy me-1"></i>Копировать
                    </button>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Файл будет доступен всем, у кого есть эта ссылка
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <a href="#" class="btn btn-primary" id="openPublicLink" target="_blank">
                    <i class="fas fa-external-link-alt me-1"></i>Открыть ссылку
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">
                    <i class="fas fa-edit me-2"></i>Переименовать
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="renameForm">
                    <div class="mb-3">
                        <label for="newName" class="form-label">Новое название:</label>
                        <input type="text" class="form-control" id="newName" required>
                        <div class="form-text">Введите новое название для <span id="itemTypeText"></span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="performRename()">
                    <i class="fas fa-save me-1"></i>Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Folder Confirmation Modal -->
<div class="modal fade" id="deleteFolderModal" tabindex="-1" aria-labelledby="deleteFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFolderModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Удаление папки
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Внимание!</strong> Эта папка содержит файлы и/или подпапки, которые будут удалены вместе с ней.
                </div>
                <p>Вы действительно хотите удалить папку <strong id="folderNameToDelete"></strong>?</p>
                <div id="folderContentsInfo" class="mb-3">
                    <p class="text-muted mb-2">Содержимое папки:</p>
                    <ul class="list-unstyled">
                        <li id="filesCount"></li>
                        <li id="subfoldersCount"></li>
                    </ul>
                </div>
                <div class="alert alert-danger">
                    <i class="fas fa-trash me-2"></i>
                    <strong>Это действие нельзя отменить!</strong> Все файлы и подпапки будут безвозвратно удалены.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteFolderBtn">
                    <i class="fas fa-trash me-1"></i>Удалить папку и всё содержимое
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Move Confirmation Modal -->
<div class="modal fade" id="moveConfirmModal" tabindex="-1" aria-labelledby="moveConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="moveConfirmModalLabel">
                    <i class="fas fa-arrows-alt me-2"></i>Перемещение
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="moveConfirmText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="confirmMoveBtn">
                    <i class="fas fa-check me-1"></i>Подтвердить
                </button>
            </div>
        </div>
    </div>
</div>



<style>
/* Стили для карточек элементов */
.item-card {
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    background: white;
    transition: all 0.2s ease;
    height: 100%;
    cursor: pointer;
    width: 100%;
}

/* Стили для текста в плитках */
.item-card h6 {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
    margin-bottom: 0.25rem;
    width: 100%;
    min-width: 0;
}

.item-card .text-muted {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
    font-size: 0.875rem;
    width: 100%;
    min-width: 0;
}

.item-card .flex-grow-1 {
    min-width: 0;
    overflow: hidden;
}

.item-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.folder-item {
    border-left: 4px solid #ffc107;
}

.file-item {
    border-left: 4px solid #0d6efd;
}

/* Стили для табличного представления */
.table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
}

body.dark-theme .table th {
    background-color: var(--border-dark);
    color: var(--text-dark);
}

.table td {
    vertical-align: middle;
}

body.dark-theme .table td {
    color: var(--text-dark);
}

/* Активные кнопки переключения режимов */
.btn-group .btn.active {
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.btn-group .btn:not(.active) {
    background-color: transparent;
    border-color: #6c757d;
    color: #6c757d;
}

.btn-group .btn:not(.active):hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Контекстное меню */
.context-menu {
    position: fixed;
    background: white;
    border: 1px solid var(--border-light);
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 200px;
    padding: 0.5rem 0;
}

body.dark-theme .context-menu {
    background: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
}

.context-menu-item {
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
    color: var(--text-light);
}

body.dark-theme .context-menu-item {
    color: var(--text-dark);
}

.context-menu-item:hover {
    background-color: var(--border-light);
}

body.dark-theme .context-menu-item:hover {
    background-color: var(--border-dark);
}

.context-menu-divider {
    height: 1px;
    background-color: var(--border-light);
    margin: 0.5rem 0;
}

body.dark-theme .context-menu-divider {
    background-color: var(--border-dark);
}

/* Стили для кнопки возврата */
.breadcrumb .btn {
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
}

/* Стили для sidebar */
.sidebar {
    background: white;
    border: 1px solid var(--border-light);
}

body.dark-theme .sidebar {
    background: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
}

/* Стили для статистики */
.stats-card {
    background: white;
    border: 1px solid var(--border-light);
    color: var(--text-light);
}

body.dark-theme .stats-card {
    background: var(--bg-dark);
    border-color: var(--border-dark);
    color: var(--text-dark);
}

/* Стили для breadcrumb */
.breadcrumb {
    background: transparent;
}

body.dark-theme .breadcrumb {
    color: var(--text-dark);
}

.breadcrumb-item a {
    color: var(--cyan-glow);
}

body.dark-theme .breadcrumb-item a {
    color: var(--cyan-glow);
}

/* Стили для просмотрщика изображений */
.image-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    background: var(--border-light);
    border-radius: 10px;
    padding: 20px;
}

body.dark-theme .image-container {
    background: var(--border-dark);
}

.image-container img {
    max-width: 100%;
    max-height: 70vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.image-info {
    background: var(--border-light);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

body.dark-theme .image-info {
    background: var(--border-dark);
    border-color: var(--border-dark);
}

.image-info p {
    margin: 0;
    font-size: 0.9rem;
}

/* Стили для модальных окон */
.modal-content {
    background: white;
    color: var(--text-light);
}

body.dark-theme .modal-content {
    background: var(--bg-dark);
    color: var(--text-dark);
}

.modal-header {
    border-bottom: 1px solid var(--border-light);
}

body.dark-theme .modal-header {
    border-bottom-color: var(--border-dark);
}

.modal-footer {
    border-top: 1px solid var(--border-light);
}

body.dark-theme .modal-footer {
    border-top-color: var(--border-dark);
}

/* Стили для алертов */
.alert {
    border: 1px solid var(--border-light);
}

body.dark-theme .alert {
    border-color: var(--border-dark);
}

/* Стили для просмотрщика PDF */
.pdf-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    background: var(--border-light);
    border-radius: 10px;
    padding: 20px;
    width: 100%;
}

body.dark-theme .pdf-container {
    background: var(--border-dark);
}

.pdf-container iframe {
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    width: 100% !important;
    height: 85vh !important;
    min-width: 100%;
    min-height: 85vh;
}

.pdf-info {
    background: var(--border-light);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

body.dark-theme .pdf-info {
    background: var(--border-dark);
    border-color: var(--border-dark);
}

/* Стили для просмотрщика документов */
.document-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 300px;
    background: var(--border-light);
    border-radius: 10px;
    padding: 20px;
    width: 100%;
}

body.dark-theme .document-container {
    background: var(--border-dark);
}

.document-container iframe {
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    width: 100% !important;
    height: 70vh !important;
    min-width: 100%;
    min-height: 70vh;
}

.document-container .text-center {
    width: 100%;
}

.document-container .text-center h5 {
    color: var(--text-light);
    margin-bottom: 1rem;
}

body.dark-theme .document-container .text-center h5 {
    color: var(--text-dark);
}

.document-container .text-center p {
    color: var(--text-light);
    margin-bottom: 0.5rem;
}

body.dark-theme .document-container .text-center p {
    color: var(--text-dark);
}

.document-container .text-center .fa-3x {
    color: var(--inactive);
}

.document-info {
    background: var(--border-light);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

body.dark-theme .document-info {
    background: var(--border-dark);
    border-color: var(--border-dark);
}

/* Стили для просмотрщика текста */
.text-container {
    max-height: 60vh;
    overflow: auto;
    background: var(--bg-light);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 20px;
}

body.dark-theme .text-container {
    background: var(--bg-dark);
    border-color: var(--border-dark);
}

.text-content {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.5;
    color: var(--text-light);
    background: transparent;
    border: none;
    margin: 0;
    white-space: pre-wrap;
    word-wrap: break-word;
}

body.dark-theme .text-content {
    color: var(--text-dark);
}

.text-info {
    background: var(--border-light);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

body.dark-theme .text-info {
    background: var(--border-dark);
    border-color: var(--border-dark);
}






</style>

<script>
// Проверка загрузки необходимых библиотек
console.log('=== SCRIPT LOADING ===');
console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
console.log('jQuery available:', typeof $ !== 'undefined');

// Функция для управления мобильной боковой панелью
function toggleMobileSidebar() {
    const mobileSidebar = document.getElementById('mobileSidebar');
    if (mobileSidebar) {
        mobileSidebar.classList.toggle('show');
        
        // Блокируем прокрутку основного контента при открытой панели
        if (mobileSidebar.classList.contains('show')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
}

// Закрытие мобильной панели при клике вне её
document.addEventListener('click', function(event) {
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileNavToggle = document.querySelector('.mobile-nav-toggle');
    
    if (mobileSidebar && mobileSidebar.classList.contains('show')) {
        if (!mobileSidebar.contains(event.target) && !mobileNavToggle.contains(event.target)) {
            mobileSidebar.classList.remove('show');
            document.body.style.overflow = '';
        }
    }
});

// Закрытие мобильной панели при нажатии Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const mobileSidebar = document.getElementById('mobileSidebar');
        if (mobileSidebar && mobileSidebar.classList.contains('show')) {
            mobileSidebar.classList.remove('show');
            document.body.style.overflow = '';
        }
    }
});

// Функция для переключения режима отображения
function setViewMode(mode) {
    console.log('Setting view mode:', mode);
    
    const tileView = document.getElementById('tileView');
    const tableView = document.getElementById('tableView');
    const tileContent = document.getElementById('tileViewContent');
    const tableContent = document.getElementById('tableViewContent');
    
    if (!tileView || !tableView || !tileContent || !tableContent) {
        console.error('View mode elements not found:', {
            tileView: !!tileView,
            tableView: !!tableView,
            tileContent: !!tileContent,
            tableContent: !!tableContent
        });
        return;
    }
    
    // Убираем активный класс со всех кнопок
    tileView.classList.remove('active');
    tableView.classList.remove('active');
    
    // Скрываем все контенты
    tileContent.style.display = 'none';
    tableContent.style.display = 'none';
    
    if (mode === 'tile') {
        tileView.classList.add('active');
        tileContent.style.display = 'block';
        localStorage.setItem('viewMode', 'tile');
        console.log('Tile view activated');
    } else if (mode === 'table') {
        tableView.classList.add('active');
        tableContent.style.display = 'block';
        localStorage.setItem('viewMode', 'table');
        console.log('Table view activated');
    }
}

// Функция для открытия папки
function openFolder(folderId) {
    if (folderId === 0) {
        window.location.href = '/';
    } else {
        window.location.href = `/?folder=${folderId}`;
    }
}

// Переменные для контекстного меню
let currentContextType = '';
let currentContextId = 0;
let currentContextName = '';
let currentContextPublicUrl = '';

// Функция для показа контекстного меню
function showContextMenu(event, type, id, name, publicUrl = '') {
    event.preventDefault();
    
    currentContextType = type;
    currentContextId = id;
    currentContextName = name;
    currentContextPublicUrl = publicUrl;
    
    const contextMenu = document.getElementById('contextMenu');
    const contextOpen = document.getElementById('contextOpen');
    const contextView = document.getElementById('contextView');
    const contextDownload = document.getElementById('contextDownload');
    const contextPublicLink = document.getElementById('contextPublicLink');
    const contextTogglePublic = document.getElementById('contextTogglePublic');
    const contextDelete = document.getElementById('contextDelete');
    
    // Показываем/скрываем элементы в зависимости от типа
    if (type === 'folder') {
        contextOpen.style.display = 'block';
        contextView.style.display = 'none';
        contextDownload.style.display = 'none';
        contextPublicLink.style.display = 'none';
        contextTogglePublic.style.display = 'none';
        contextOpen.innerHTML = '<i class="fas fa-folder-open me-2"></i>Открыть';
    } else {
        contextOpen.style.display = 'none';
        contextDownload.style.display = 'block';
        
        // Проверяем, поддерживается ли просмотр файла
        const isImage = currentContextName.match(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i);
        const isPdf = currentContextName.match(/\.pdf$/i);
        const isDocument = currentContextName.match(/\.(doc|docx|xls|xlsx|ppt|pptx|odt|ods|odp)$/i);
        const isText = currentContextName.match(/\.(txt|md|html|css|js|py|java|cpp|c|h|json|xml|log)$/i);
        
        if (isImage || isPdf || isDocument || isText) {
            contextView.style.display = 'block';
            if (isImage) {
                contextView.innerHTML = '<i class="fas fa-eye me-2"></i>Просмотр изображения';
            } else if (isPdf) {
                contextView.innerHTML = '<i class="fas fa-eye me-2"></i>Просмотр PDF';
            } else if (isDocument) {
                contextView.innerHTML = '<i class="fas fa-eye me-2"></i>Просмотр в OnlyOffice';
            } else if (isText) {
                contextView.innerHTML = '<i class="fas fa-eye me-2"></i>Просмотр текста';
            }
        } else {
            contextView.style.display = 'none';
        }
        
        // Показываем публичную ссылку только если файл публичный
        contextPublicLink.style.display = currentContextPublicUrl ? 'block' : 'none';
        // Показываем кнопку управления публичным доступом
        contextTogglePublic.style.display = 'block';
        if (currentContextPublicUrl) {
            contextTogglePublic.innerHTML = '<i class="fas fa-lock me-2"></i>Сделать приватным';
            contextTogglePublic.className = 'context-menu-item text-warning';
        } else {
            contextTogglePublic.innerHTML = '<i class="fas fa-globe me-2"></i>Сделать публичным';
            contextTogglePublic.className = 'context-menu-item';
        }
    }
    
    // Позиционируем меню
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    contextMenu.style.display = 'block';
    
    // Добавляем обработчики событий
    contextOpen.onclick = () => handleContextAction('open');
    contextView.onclick = () => handleContextAction('view');
    contextDownload.onclick = () => handleContextAction('download');
    contextPublicLink.onclick = () => handleContextAction('publicLink');
    contextTogglePublic.onclick = () => handleContextAction('togglePublic');
    contextRename.onclick = () => handleContextAction('rename');
    contextDelete.onclick = () => handleContextAction('delete');
}

// Функция для обработки действий контекстного меню
function handleContextAction(action) {
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
    
    switch (action) {
        case 'open':
            if (currentContextType === 'folder') {
                openFolder(currentContextId);
            }
            break;
        case 'view':
            if (currentContextType === 'file') {
                // Проверяем тип файла и открываем соответствующий просмотрщик
                const isImage = currentContextName.match(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i);
                const isPdf = currentContextName.match(/\.pdf$/i);
                const isDocument = currentContextName.match(/\.(doc|docx|xls|xlsx|ppt|pptx|odt|ods|odp)$/i);
                const isText = currentContextName.match(/\.(txt|md|html|css|js|py|java|cpp|c|h|json|xml|log)$/i);
                
                if (isImage) {
                    openImageViewer(currentContextId, currentContextName, '');
                } else if (isPdf) {
                    openPdfViewer(currentContextId, currentContextName, '');
                } else if (isDocument) {
                    openDocumentViewer(currentContextId, currentContextName, '');
                } else if (isText) {
                    openTextViewer(currentContextId, currentContextName, '');
                }
            }
            break;
        case 'download':
            if (currentContextType === 'file') {
                window.location.href = `/file/${currentContextId}`;
            }
            break;
        case 'publicLink':
            if (currentContextType === 'file' && currentContextPublicUrl) {
                // Показываем модальное окно с публичной ссылкой
                showPublicLinkModal(currentContextPublicUrl);
            }
            break;
        case 'togglePublic':
            if (currentContextType === 'file') {
                handleTogglePublic(currentContextId, currentContextPublicUrl);
            }
            break;
        case 'rename':
            showRenameModal();
            break;
        case 'delete':
            if (currentContextType === 'folder') {
                // Показываем модальное окно для удаления папки
                showDeleteFolderModal(currentContextId, currentContextName);
            } else {
                // Удаление файла
                if (confirm(`Удалить файл "${currentContextName}"?`)) {
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/file/${currentContextId}/delete`;
                    
                    // Добавляем CSRF токен
                    const csrfField = document.createElement('input');
                    csrfField.type = 'hidden';
                    csrfField.name = 'csrf_token';
                    csrfField.value = '{{ csrf_token }}' || '';
                    form.appendChild(csrfField);
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            }
            break;
    }
}

// Функция для управления публичным доступом к файлу
function handleTogglePublic(fileId, currentPublicUrl) {
    const isCurrentlyPublic = !!currentPublicUrl;
    const action = isCurrentlyPublic ? 'Сделать приватным' : 'Сделать публичным';
    
    if (confirm(`${action} файл?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/file/${fileId}/toggle_public`;
        
        // Добавляем CSRF токен
        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = 'csrf_token';
        csrfField.value = '{{ csrf_token }}' || '';
        form.appendChild(csrfField);
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Функция для показа модального окна с публичной ссылкой
function showPublicLinkModal(publicUrl) {
    const modal = new bootstrap.Modal(document.getElementById('publicLinkModal'));
    const linkInput = document.getElementById('publicLinkInput');
    const openLinkBtn = document.getElementById('openPublicLink');
    
    // Формируем полный URL
    const fullUrl = `${window.location.origin}/public/${publicUrl}`;
    
    // Устанавливаем ссылку в поле ввода
    linkInput.value = fullUrl;
    
    // Устанавливаем ссылку для кнопки "Открыть ссылку"
    openLinkBtn.href = fullUrl;
    
    // Показываем модальное окно
    modal.show();
}

// Функция для показа модального окна удаления папки
function showDeleteFolderModal(folderId, folderName) {
    // Получаем информацию о содержимом папки
    fetch(`/api/folder/${folderId}/contents`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = new bootstrap.Modal(document.getElementById('deleteFolderModal'));
                
                // Заполняем информацию о папке
                document.getElementById('folderNameToDelete').textContent = folderName;
                
                if (data.files_count > 0 || data.subfolders_count > 0) {
                    // Папка содержит файлы или подпапки
                    const filesCount = document.getElementById('filesCount');
                    const subfoldersCount = document.getElementById('subfoldersCount');
                    const folderContentsInfo = document.getElementById('folderContentsInfo');
                    const warningAlert = document.querySelector('#deleteFolderModal .alert-warning');
                    const dangerAlert = document.querySelector('#deleteFolderModal .alert-danger');
                    
                    // Показываем информацию о содержимом
                    filesCount.innerHTML = `<i class="fas fa-file me-2"></i>Файлов: <strong>${data.files_count}</strong>`;
                    subfoldersCount.innerHTML = `<i class="fas fa-folder me-2"></i>Подпапок: <strong>${data.subfolders_count}</strong>`;
                    folderContentsInfo.style.display = 'block';
                    warningAlert.style.display = 'block';
                    dangerAlert.style.display = 'block';
                    
                    // Обновляем текст кнопки
                    document.getElementById('confirmDeleteFolderBtn').innerHTML = '<i class="fas fa-trash me-1"></i>Удалить папку и всё содержимое';
                } else {
                    // Пустая папка
                    const folderContentsInfo = document.getElementById('folderContentsInfo');
                    const warningAlert = document.querySelector('#deleteFolderModal .alert-warning');
                    const dangerAlert = document.querySelector('#deleteFolderModal .alert-danger');
                    
                    // Скрываем информацию о содержимом и предупреждения
                    folderContentsInfo.style.display = 'none';
                    warningAlert.style.display = 'none';
                    dangerAlert.style.display = 'none';
                    
                    // Обновляем текст кнопки
                    document.getElementById('confirmDeleteFolderBtn').innerHTML = '<i class="fas fa-trash me-1"></i>Удалить папку';
                }
                
                // Обработчик кнопки подтверждения
                document.getElementById('confirmDeleteFolderBtn').onclick = function() {
                    deleteFolder(folderId);
                    modal.hide();
                };
                
                // Показываем модальное окно
                modal.show();
            } else {
                // Если не удалось получить информацию, показываем простое подтверждение
                if (confirm(`Удалить папку "${folderName}"?`)) {
                    deleteFolder(folderId);
                }
            }
        })
        .catch(error => {
            console.error('Ошибка при получении информации о папке:', error);
            // Fallback: показываем простое подтверждение
            if (confirm(`Удалить папку "${folderName}"?`)) {
                deleteFolder(folderId);
            }
        });
}

// Функция для удаления папки
function deleteFolder(folderId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/folder/${folderId}/delete`;
    
    // Добавляем CSRF токен
    const csrfField = document.createElement('input');
    csrfField.type = 'hidden';
    csrfField.name = 'csrf_token';
    csrfField.value = '{{ csrf_token }}' || '';
    form.appendChild(csrfField);
    
    document.body.appendChild(form);
    form.submit();
}



// Функция для копирования публичной ссылки
function copyPublicLink() {
    const linkInput = document.getElementById('publicLinkInput');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // Для мобильных устройств
    
    try {
        document.execCommand('copy');
        // Показываем уведомление об успешном копировании
        const copyBtn = event.target;
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Скопировано!';
        copyBtn.className = 'btn btn-success';
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.className = 'btn btn-outline-primary';
        }, 2000);
    } catch (err) {
        console.error('Ошибка при копировании: ', err);
        // Fallback для современных браузеров
        if (navigator.clipboard) {
            navigator.clipboard.writeText(linkInput.value).then(() => {
                const copyBtn = event.target;
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check me-1"></i>Скопировано!';
                copyBtn.className = 'btn btn-success';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.className = 'btn btn-outline-primary';
                }, 2000);
            });
        }
    }
}

// Скрываем контекстное меню при клике вне его
document.addEventListener('click', function() {
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
});

// Скрываем контекстное меню при нажатии Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const contextMenu = document.getElementById('contextMenu');
        contextMenu.style.display = 'none';
    }
});







// Обработчик сброса элемента
function handleDrop(event, targetType, targetId) {
    console.log('=== DROP EVENT ===');
    console.log('Target type:', targetType);
    console.log('Target ID:', targetId);
    console.log('Dragged element:', draggedElement);
    console.log('Dragged type:', draggedType);
    console.log('Dragged name:', draggedName);
    
    event.preventDefault();
    event.stopPropagation();
    
    // Проверяем, что у нас есть данные о перетаскиваемом элементе
    if (!draggedType || !draggedId || !draggedName) {
        console.error('No drag data available');
        return;
    }
    
    const dropZone = event.currentTarget;
    if (dropZone) {
        dropZone.classList.remove('drag-over');
        console.log('Removed drag-over class from drop zone');
    }
    
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        console.log('Removed dragging class from dragged element');
    }
    
    // Получаем название целевой папки
    let targetName = '';
    if (targetId === 0) {
        targetName = 'Корневая папка';
    } else if (targetType === 'folder') {
        // Ищем название папки по ID
        const folderElement = document.querySelector(`[data-type="folder"][data-id="${targetId}"]`);
        if (folderElement) {
            targetName = folderElement.getAttribute('data-name');
        } else {
            targetName = 'папку';
        }
    }
    
    console.log('Target name:', targetName);
    
    // Проверяем, что перетаскиваемый элемент не является целевой папкой
    if (draggedId === targetId && draggedType === 'folder') {
        console.log('Cannot drop folder into itself');
        alert('Нельзя переместить папку в саму себя');
        return;
    }
    
    // Проверяем, что не пытаемся переместить папку в её подпапку
    if (draggedType === 'folder' && targetId !== 0) {
        let current = targetId;
        let depth = 0;
        const maxDepth = 10; // Защита от бесконечного цикла
        
        while (current && depth < maxDepth) {
            const targetFolder = document.querySelector(`[data-type="folder"][data-id="${current}"]`);
            if (!targetFolder) break;
            
            const parentId = targetFolder.getAttribute('data-parent-id');
            if (parentId === draggedId.toString()) {
                console.log('Cannot move folder into its subfolder');
                alert('Нельзя переместить папку в её подпапку');
                return;
            }
            
            current = parentId === '0' ? 0 : parseInt(parentId);
            depth++;
        }
    }
    
    console.log('Showing move confirm modal...');
    
    // Показываем модальное окно подтверждения
    showMoveConfirmModal(draggedType, draggedName, targetName, targetId);
    
    console.log('=== DROP EVENT COMPLETE ===');
}

// Функция показа модального окна подтверждения перемещения
function showMoveConfirmModal(itemType, itemName, targetName, targetId) {
    console.log('Showing move confirm modal:', itemType, itemName, targetName, targetId);
    
    const modalElement = document.getElementById('moveConfirmModal');
    if (!modalElement) {
        console.error('Modal element not found');
        return;
    }
    
    const modalTitle = document.getElementById('moveConfirmModalLabel');
    const modalText = document.getElementById('moveConfirmText');
    const confirmBtn = document.getElementById('confirmMoveBtn');
    
    if (!modalTitle || !modalText || !confirmBtn) {
        console.error('Modal elements not found');
        return;
    }
    
    // Обновляем заголовок и текст
    modalTitle.textContent = `Переместить ${itemType === 'folder' ? 'папку' : 'файл'}?`;
    modalText.textContent = `${itemType === 'folder' ? 'Папка' : 'Файл'} «${itemName}» будет в папке «${targetName}»`;
    
    // Обработчик кнопки подтверждения
    confirmBtn.onclick = function() {
        console.log('Confirm move clicked');
        performMove(itemType, draggedId, targetId);
        // Используем глобальную функцию для скрытия модального окна
        if (window.hideBootstrapModal) {
            window.hideBootstrapModal('moveConfirmModal');
        } else {
            // Fallback для старых версий Bootstrap
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
    };
    
    // Обработчик закрытия модального окна
    modalElement.addEventListener('hidden.bs.modal', function () {
        console.log('Modal hidden, resetting variables');
        // Сбрасываем переменные при закрытии модального окна
        draggedElement = null;
        draggedType = '';
        draggedId = 0;
        draggedName = '';
    });
    
    // Показываем модальное окно
    if (window.showBootstrapModal) {
        window.showBootstrapModal('moveConfirmModal');
    } else {
        // Fallback для старых версий Bootstrap
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    }
}

// Функция выполнения перемещения
function performMove(itemType, itemId, targetId) {
    console.log('=== PERFORMING MOVE ===');
    console.log('Item type:', itemType);
    console.log('Item ID:', itemId);
    console.log('Target ID:', targetId);
    
    // Проверяем, что не пытаемся переместить папку в саму себя
    if (itemType === 'folder' && itemId === targetId) {
        console.log('Cannot move folder into itself');
        alert('Нельзя переместить папку в саму себя');
        return;
    }
    
    // Проверяем, что не пытаемся переместить папку в её подпапку
    if (itemType === 'folder' && targetId !== 0) {
        // Проверяем, является ли целевая папка подпапкой текущей
        let current = targetId;
        let depth = 0;
        const maxDepth = 10; // Защита от бесконечного цикла
        
        while (current && depth < maxDepth) {
            const targetFolder = document.querySelector(`[data-type="folder"][data-id="${current}"]`);
            if (!targetFolder) break;
            
            const parentId = targetFolder.getAttribute('data-parent-id');
            if (parentId === itemId.toString()) {
                console.log('Cannot move folder into its subfolder');
                alert('Нельзя переместить папку в её подпапку');
                return;
            }
            
            current = parentId === '0' ? 0 : parseInt(parentId);
            depth++;
        }
    }
    
    console.log('Creating move form...');
    
    // Создаем форму для перемещения
    const form = document.createElement('form');
    form.method = 'POST';
    
    if (itemType === 'folder') {
        form.action = `/folder/${itemId}/move`;
        console.log('Form action for folder:', form.action);
    } else {
        form.action = `/file/${itemId}/move`;
        console.log('Form action for file:', form.action);
    }
    
    // Добавляем скрытые поля
    const targetField = document.createElement('input');
    targetField.type = 'hidden';
    targetField.name = 'target_folder_id';
    targetField.value = targetId;
    form.appendChild(targetField);
    
    const csrfField = document.createElement('input');
    csrfField.type = 'hidden';
    csrfField.name = 'csrf_token';
    csrfField.value = '{{ csrf_token }}' || '';
    form.appendChild(csrfField);
    
    console.log('Form created with fields:', {
        target_folder_id: targetId,
        csrf_token: csrfField.value
    });
    
    // Отправляем форму
    document.body.appendChild(form);
    console.log('Form appended to body, submitting...');
    form.submit();
    
    console.log('=== MOVE FORM SUBMITTED ===');
}

// Обработчик окончания перетаскивания
function handleDragEnd(event) {
    console.log('=== DRAG END ===');
    console.log('Event:', event);
    
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        console.log('Removed dragging class from dragged element');
    }
    
    // Убираем класс drag-over со всех зон
    const dragOverElements = document.querySelectorAll('.root-drop-zone.drag-over, .folder-item.drag-over, .file-item.drag-over');
    dragOverElements.forEach(element => {
        element.classList.remove('drag-over');
        console.log('Removed drag-over class from:', element);
    });
    
    // Восстанавливаем состояние всех папок
    const folderElements = document.querySelectorAll('[data-type="folder"]');
    folderElements.forEach(folder => {
        folder.style.pointerEvents = '';
        folder.style.opacity = '';
        console.log('Restored folder state:', folder);
    });
    
    // Скрываем зону корневой папки
    const rootDropZone = document.getElementById('rootDropZone');
    const rootDropZoneTable = document.getElementById('rootDropZoneTable');
    
    if (rootDropZone) {
        rootDropZone.style.display = 'none';
        console.log('Hidden root drop zone in tile view');
    }
    
    if (rootDropZoneTable) {
        rootDropZoneTable.style.display = 'none';
        console.log('Hidden root drop zone in table view');
    }
    
    // Сбрасываем переменные
    console.log('Resetting drag variables');
    draggedElement = null;
    draggedType = '';
    draggedId = 0;
    draggedName = '';
    
    console.log('=== DRAG END COMPLETE ===');
}

// Добавляем обработчики событий для перетаскивания
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOM LOADED ===');
    console.log('Setting up drag and drop handlers');
    
    // Предотвращаем стандартное поведение браузера при перетаскивании
    document.addEventListener('dragover', function(e) {
        e.preventDefault();
        console.log('Global dragover prevented');
    });
    
    document.addEventListener('drop', function(e) {
        e.preventDefault();
        console.log('Global drop prevented');
    });
    
    // Предотвращаем перетаскивание на пустые области
    document.addEventListener('dragover', function(e) {
        // Если перетаскивание происходит над элементом, который не является зоной перетаскивания
        if (!e.target.closest('.folder-item, .root-drop-zone')) {
            e.dataTransfer.dropEffect = 'none';
            console.log('Dragover over empty area, drop effect set to none');
        }
    });
    
    // Предотвращаем перетаскивание на пустые области в плиточном представлении
    const fileList = document.getElementById('fileList');
    if (fileList) {
        fileList.addEventListener('dragover', function(e) {
            // Если перетаскивание происходит над пустой областью
            if (!e.target.closest('.item-card, .table-responsive')) {
                e.dataTransfer.dropEffect = 'none';
                console.log('Dragover over empty file list area, drop effect set to none');
            }
        });
        console.log('File list dragover handler added');
    } else {
        console.warn('File list element not found');
    }
    
    // Добавляем обработчик dragend для всех перетаскиваемых элементов
    const draggableElements = document.querySelectorAll('[draggable="true"]');
    console.log('Found draggable elements:', draggableElements.length);
    
    draggableElements.forEach(element => {
        element.addEventListener('dragend', handleDragEnd);
        console.log('Added dragend handler to:', element);
    });
    
    // Добавляем обработчики для зон перетаскивания
    const dropZones = document.querySelectorAll('.folder-item, .root-drop-zone');
    console.log('Found drop zones:', dropZones.length);
    
    dropZones.forEach(zone => {
        const targetId = zone.getAttribute('data-id') || 0;
        const targetType = zone.getAttribute('data-type') || 'folder';
        
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('drop', function(event) {
            console.log('Drop event on zone:', targetId, targetType);
            handleDrop(event, targetType, targetId);
        });
        
        console.log('Added drop handlers to zone:', zone, 'ID:', targetId, 'Type:', targetType);
    });
    
    // Предотвращаем перетаскивание на файлы
    const fileItems = document.querySelectorAll('.file-item');
    console.log('Found file items:', fileItems.length);
    
    fileItems.forEach(file => {
        file.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'none';
            console.log('File dragover prevented');
        });
        file.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('File drop prevented');
        });
    });
    
    // Предотвращаем перетаскивание на пустые области таблицы
    const tableBody = document.querySelector('tbody');
    if (tableBody) {
        tableBody.addEventListener('dragover', function(e) {
            // Если перетаскивание происходит над пустой областью таблицы
            if (!e.target.closest('tr')) {
                e.dataTransfer.dropEffect = 'none';
                console.log('Table body dragover over empty area, drop effect set to none');
            }
        });
        console.log('Table body dragover handler added');
    } else {
        console.warn('Table body element not found');
    }
    
    // Добавляем обработчики для галереи изображений
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    
    if (prevImageBtn) {
        prevImageBtn.addEventListener('click', showPreviousImage);
        console.log('Previous image button handler added');
    }
    
    if (nextImageBtn) {
        nextImageBtn.addEventListener('click', showNextImage);
        console.log('Next image button handler added');
    }
    
    // Добавляем обработчики клавиатуры для галереи
    document.addEventListener('keydown', function(event) {
        if (document.getElementById('imageViewerModal').classList.contains('show')) {
            if (event.key === 'ArrowLeft') {
                event.preventDefault();
                showPreviousImage();
            } else if (event.key === 'ArrowRight') {
                event.preventDefault();
                showNextImage();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                const modal = bootstrap.Modal.getInstance(document.getElementById('imageViewerModal'));
                if (modal) modal.hide();
            }
        }
    });
    
    // Добавляем поддержку свайпов для мобильных устройств
    let touchStartX = 0;
    let touchEndX = 0;
    
    const imageViewerModal = document.getElementById('imageViewerModal');
    if (imageViewerModal) {
        imageViewerModal.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });
        
        imageViewerModal.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });
    }
    
    function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > swipeThreshold) {
            if (diff > 0) {
                // Свайп влево - следующее изображение
                showNextImage();
            } else {
                // Свайп вправо - предыдущее изображение
                showPreviousImage();
            }
        }
    }
    
    // Предотвращаем перетаскивание на заголовок таблицы
    const tableHeader = document.querySelector('thead');
    if (tableHeader) {
        tableHeader.addEventListener('dragover', function(e) {
            e.dataTransfer.dropEffect = 'none';
            console.log('Table header dragover prevented');
        });
        console.log('Table header dragover handler added');
    } else {
        console.warn('Table header element not found');
    }
    
    // Восстанавливаем выбранный режим
    const savedMode = localStorage.getItem('viewMode') || 'tile';
    console.log('Restoring view mode:', savedMode);
    setViewMode(savedMode);
    
    console.log('=== DRAG AND DROP SETUP COMPLETE ===');
    
    // Инициализация ленивой загрузки миниатюр
    initializeLazyLoading();
});

// Функция для ленивой загрузки миниатюр
function initializeLazyLoading() {
    const thumbnails = document.querySelectorAll('.file-thumbnail[loading="lazy"]');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.classList.add('loaded');
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: '50px 0px',
        threshold: 0.1
    });
    
    thumbnails.forEach(img => {
        imageObserver.observe(img);
    });
}

// Функция для показа модального окна переименования
function showRenameModal() {
    const renameModal = document.getElementById('renameModal');
    const newNameInput = document.getElementById('newName');
    const itemTypeText = document.getElementById('itemTypeText');
    
    // Устанавливаем текущее название в поле ввода
    newNameInput.value = currentContextName;
    
    // Устанавливаем текст типа элемента
    if (currentContextType === 'folder') {
        itemTypeText.textContent = 'папки';
    } else {
        itemTypeText.textContent = 'файла';
    }
    
    // Показываем модальное окно
    const modal = new bootstrap.Modal(renameModal);
    modal.show();
    
    // Фокусируемся на поле ввода и выделяем весь текст
    setTimeout(() => {
        newNameInput.focus();
        newNameInput.select();
    }, 100);
}

// Функция для выполнения переименования
function performRename() {
    const newName = document.getElementById('newName').value.trim();
    
    if (!newName) {
        alert('Введите новое название');
        return;
    }
    
    // Создаем форму для переименования
    const form = document.createElement('form');
    form.method = 'POST';
    
    if (currentContextType === 'folder') {
        form.action = `/folder/${currentContextId}/rename`;
    } else {
        form.action = `/file/${currentContextId}/rename`;
    }
    
    // Добавляем скрытые поля
    const nameField = document.createElement('input');
    nameField.type = 'hidden';
    nameField.name = 'new_name';
    nameField.value = newName;
    form.appendChild(nameField);
    
    const csrfField = document.createElement('input');
    csrfField.type = 'hidden';
    csrfField.name = 'csrf_token';
    csrfField.value = '{{ csrf_token }}' || '';
    form.appendChild(csrfField);
    
    // Отправляем форму
    document.body.appendChild(form);
    form.submit();
}

// Глобальные переменные для галереи изображений
let currentImageIndex = 0;
let imageFiles = [];
let currentFolderId = null;
let currentKeydownHandler = null; // Глобальная переменная для хранения ссылки на обработчик клавиатуры

// Функция для открытия просмотрщика изображений
function openImageViewer(fileId, fileName, fileSize) {
    // Получаем текущую папку
    const urlParams = new URLSearchParams(window.location.search);
    currentFolderId = urlParams.get('folder') || 0;
    
    // Получаем все изображения в текущей папке
    getImageFiles(currentFolderId, fileId);
    
    // Устанавливаем изображение в модальном окне
    const imageViewerImg = document.getElementById('imageViewerImg');
    const imageFileName = document.getElementById('imageFileName');
    const imageFileSize = document.getElementById('imageFileSize');
    const downloadImageBtn = document.getElementById('downloadImageBtn');
    
    // Устанавливаем источник изображения для просмотра
    imageViewerImg.src = `/view/${fileId}`;
    
    // Добавляем обработчик загрузки для проверки успешности
    imageViewerImg.onload = function() {
        console.log('Изображение загружено успешно');
        // Добавляем класс для анимации
        imageViewerImg.classList.add('show');
    };
    
    // Устанавливаем информацию о файле
    imageFileName.textContent = fileName;
    imageFileSize.textContent = fileSize || '';
    
    // Устанавливаем ссылку для скачивания
    downloadImageBtn.href = `/file/${fileId}`;
    
    // Показываем модальное окно
    const imageViewerModal = new bootstrap.Modal(document.getElementById('imageViewerModal'));
    
    // Добавляем обработчик закрытия модального окна
    document.getElementById('imageViewerModal').addEventListener('hidden.bs.modal', function () {
        // Сбрасываем состояние галереи
        currentImageIndex = 0;
        imageFiles = [];
        console.log('Модальное окно закрыто, галерея сброшена');
        
        // Удаляем обработчик клавиатуры
        if (currentKeydownHandler) {
            document.removeEventListener('keydown', currentKeydownHandler);
            currentKeydownHandler = null;
            console.log('Обработчик клавиатуры удален при закрытии модального окна');
        }
    });
    
    // Добавляем обработчики для навигационных кнопок
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    
    if (prevBtn) {
        // Удаляем старые обработчики
        prevBtn.replaceWith(prevBtn.cloneNode(true));
        const newPrevBtn = document.getElementById('prevImageBtn');
        newPrevBtn.addEventListener('click', function() {
            console.log('Кнопка "Предыдущее" нажата');
            showPreviousImage();
        });
        console.log('Обработчик для кнопки "Предыдущее" добавлен');
    }
    
    if (nextBtn) {
        // Удаляем старые обработчики
        nextBtn.replaceWith(nextBtn.cloneNode(true));
        const newNextBtn = document.getElementById('nextImageBtn');
        newNextBtn.addEventListener('click', function() {
            console.log('Кнопка "Следующее" нажата');
            showNextImage();
        });
        console.log('Обработчик для кнопки "Следующее" добавлен');
    }
    
    // Удаляем предыдущий обработчик клавиатуры, если он существует
    if (currentKeydownHandler) {
        document.removeEventListener('keydown', currentKeydownHandler);
        console.log('Предыдущий обработчик клавиатуры удален');
    }
    
    // Добавляем обработчик клавиатуры для галереи
    currentKeydownHandler = function(event) {
        // Проверяем, что модальное окно открыто
        const modal = document.getElementById('imageViewerModal');
        if (!modal || !modal.classList.contains('show')) {
            return;
        }
        
        // Проверяем, что галерея активна и есть изображения
        if (!imageFiles || imageFiles.length <= 1) {
            return;
        }
        
        if (event.key === 'ArrowLeft') {
            event.preventDefault();
            console.log('Нажата клавиша "Стрелка влево"');
            showPreviousImage();
        } else if (event.key === 'ArrowRight') {
            event.preventDefault();
            console.log('Нажата клавиша "Стрелка вправо"');
            showNextImage();
        } else if (event.key === 'Escape') {
            event.preventDefault();
            console.log('Нажата клавиша "Escape"');
            imageViewerModal.hide();
        }
    };
    
    document.addEventListener('keydown', currentKeydownHandler);
    console.log('Новый обработчик клавиатуры добавлен');
    
    // Удаляем обработчик клавиатуры при закрытии модального окна
    document.getElementById('imageViewerModal').addEventListener('hidden.bs.modal', function () {
        if (currentKeydownHandler) {
            document.removeEventListener('keydown', currentKeydownHandler);
            currentKeydownHandler = null;
            console.log('Обработчик клавиатуры удален при закрытии модального окна');
        }
    });
    
    imageViewerModal.show();
}

// Функция для получения всех изображений в папке
function getImageFiles(folderId, currentFileId) {
    console.log('getImageFiles вызвана с параметрами:', { folderId, currentFileId });
    
    // Получаем только изображения из текущего представления (плиточного или табличного)
    let imageElements;
    
    // Проверяем, какое представление активно
    const tileView = document.getElementById('tileView');
    const tableView = document.getElementById('tableView');
    
    if (tileView && tileView.classList.contains('active')) {
        // Плиточное представление
        imageElements = document.querySelectorAll('#tileViewContent .file-item[data-file-id]');
        console.log('Поиск в плиточном представлении');
    } else if (tableView && tableView.classList.contains('active')) {
        // Табличное представление
        imageElements = document.querySelectorAll('#tableViewContent tbody tr[data-file-id]');
        console.log('Поиск в табличном представлении');
    } else {
        // По умолчанию ищем в плиточном представлении
        imageElements = document.querySelectorAll('#tileViewContent .file-item[data-file-id]');
        console.log('Поиск в плиточном представлении (по умолчанию)');
    }
    
    console.log('Найдено элементов с data-file-id в текущем представлении:', imageElements.length);
    
    imageFiles = [];
    
    imageElements.forEach((element, index) => {
        // Проверяем, что элемент действительно видим и находится в текущем представлении
        if (element.offsetParent === null || element.style.display === 'none') {
            console.log(`Элемент ${index} скрыт, пропускаем`);
            return;
        }
        
        const fileId = element.getAttribute('data-file-id');
        const fileName = element.getAttribute('data-file-name');
        const fileSize = element.getAttribute('data-file-size');
        const mimeType = element.getAttribute('data-mime-type');
        
        console.log(`Элемент ${index}:`, { fileId, fileName, fileSize, mimeType });
        
        if (mimeType && mimeType.startsWith('image/')) {
            // Проверяем, что изображение еще не добавлено
            const existingImage = imageFiles.find(img => img.id === fileId);
            if (!existingImage) {
                imageFiles.push({
                    id: fileId,
                    name: fileName,
                    size: fileSize,
                    mimeType: mimeType
                });
                console.log('Добавлено изображение:', { fileId, fileName, mimeType });
            } else {
                console.log('Изображение уже добавлено, пропускаем дубликат:', { fileId, fileName });
            }
        }
    });
    
    console.log('Найдено изображений:', imageFiles.length);
    console.log('Изображения:', imageFiles);
    
    // Находим индекс текущего изображения
    currentImageIndex = imageFiles.findIndex(img => img.id == currentFileId);
    if (currentImageIndex === -1) {
        console.log('Текущее изображение не найдено в списке, устанавливаем индекс 0');
        currentImageIndex = 0;
    }
    
    console.log('Текущий индекс:', currentImageIndex);
    
    // Обновляем навигацию
    updateImageNavigation();
}

// Функция для обновления навигации
function updateImageNavigation() {
    console.log('updateImageNavigation вызвана');
    console.log('imageFiles.length:', imageFiles.length);
    console.log('currentImageIndex:', currentImageIndex);
    
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    const counter = document.getElementById('imageCounter');
    
    console.log('Найдены элементы:', { prevBtn: !!prevBtn, nextBtn: !!nextBtn, counter: !!counter });
    
    if (imageFiles.length <= 1) {
        console.log('Изображений <= 1, скрываем навигацию');
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (counter) counter.style.display = 'none';
        return;
    }
    
    console.log('Показываем навигацию для', imageFiles.length, 'изображений');
    if (prevBtn) prevBtn.style.display = 'block';
    if (nextBtn) nextBtn.style.display = 'block';
    if (counter) counter.style.display = 'block';
    
    // Дополнительная проверка: убеждаемся, что текущий индекс в допустимых пределах
    if (currentImageIndex < 0) {
        currentImageIndex = 0;
        console.log('Исправлен отрицательный индекс на 0');
    } else if (currentImageIndex >= imageFiles.length) {
        currentImageIndex = imageFiles.length - 1;
        console.log('Исправлен индекс за пределами массива на', currentImageIndex);
    }
    
    // Проверяем, что массив изображений не пустой
    if (imageFiles.length === 0) {
        console.log('Массив изображений пуст, скрываем навигацию');
        if (prevBtn) prevBtn.style.display = 'none';
        if (nextBtn) nextBtn.style.display = 'none';
        if (counter) counter.style.display = 'none';
        return;
    }
    
    // Обновляем счетчик
    if (counter) {
        counter.textContent = `${currentImageIndex + 1} / ${imageFiles.length}`;
        console.log('Счетчик обновлен:', counter.textContent);
    }
    
    // Обновляем состояние кнопок
    if (prevBtn) {
        prevBtn.disabled = currentImageIndex === 0;
        console.log('Кнопка "Предыдущее" отключена:', prevBtn.disabled);
    }
    if (nextBtn) {
        nextBtn.disabled = currentImageIndex === imageFiles.length - 1;
        console.log('Кнопка "Следующее" отключена:', nextBtn.disabled);
    }
}

// Функция для перехода к предыдущему изображению
function showPreviousImage() {
    console.log('showPreviousImage вызвана');
    console.log('currentImageIndex:', currentImageIndex);
    console.log('imageFiles.length:', imageFiles.length);
    
    // Проверяем, что галерея активна
    if (!imageFiles || imageFiles.length === 0) {
        console.log('Галерея не активна, пропускаем');
        return;
    }
    
    if (currentImageIndex > 0) {
        currentImageIndex--;
        console.log('Переход к предыдущему изображению, новый индекс:', currentImageIndex);
        showImageByIndex(currentImageIndex);
    } else {
        console.log('Нельзя перейти к предыдущему изображению - уже первое');
    }
}

// Функция для перехода к следующему изображению
function showNextImage() {
    console.log('showNextImage вызвана');
    console.log('currentImageIndex:', currentImageIndex);
    console.log('imageFiles.length:', imageFiles.length);
    
    // Проверяем, что галерея активна
    if (!imageFiles || imageFiles.length === 0) {
        console.log('Галерея не активна, пропускаем');
        return;
    }
    
    if (currentImageIndex < imageFiles.length - 1) {
        currentImageIndex++;
        console.log('Переход к следующему изображению, новый индекс:', currentImageIndex);
        showImageByIndex(currentImageIndex);
    } else {
        console.log('Нельзя перейти к следующему изображению - уже последнее');
    }
}

// Функция для показа изображения по индексу
function showImageByIndex(index) {
    console.log('showImageByIndex вызвана с индексом:', index);
    console.log('imageFiles:', imageFiles);
    
    // Проверяем, что галерея активна
    if (!imageFiles || imageFiles.length === 0) {
        console.log('Галерея не активна, пропускаем');
        return;
    }
    
    if (index < 0 || index >= imageFiles.length) {
        console.log('Индекс вне диапазона:', index, 'длина массива:', imageFiles.length);
        return;
    }
    
    const image = imageFiles[index];
    console.log('Показываем изображение:', image);
    
    const imageViewerImg = document.getElementById('imageViewerImg');
    const imageFileName = document.getElementById('imageFileName');
    const imageFileSize = document.getElementById('imageFileSize');
    const downloadImageBtn = document.getElementById('downloadImageBtn');
    
    // Проверяем, что элементы существуют
    if (!imageViewerImg || !imageFileName || !imageFileSize || !downloadImageBtn) {
        console.log('Не все элементы найдены, пропускаем');
        return;
    }
    
    // Анимация смены изображения
    imageViewerImg.classList.add('image-fade');
    
    setTimeout(() => {
        // Обновляем изображение
        imageViewerImg.src = `/view/${image.id}`;
        imageFileName.textContent = image.name;
        imageFileSize.textContent = image.size || '';
        downloadImageBtn.href = `/file/${image.id}`;
        
        // Показываем изображение
        imageViewerImg.classList.remove('image-fade');
        imageViewerImg.classList.add('show');
        
        // Обновляем навигацию
        updateImageNavigation();
    }, 150);
}

// Функция для открытия просмотрщика PDF
function openPdfViewer(fileId, fileName, fileSize) {
    const pdfViewerFrame = document.getElementById('pdfViewerFrame');
    const pdfFileName = document.getElementById('pdfFileName');
    const pdfFileSize = document.getElementById('pdfFileSize');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    
    // Устанавливаем источник PDF для просмотра
    pdfViewerFrame.src = `/view/${fileId}`;
    
    // Добавляем обработчик загрузки для проверки успешности
    pdfViewerFrame.onload = function() {
        try {
            // Проверяем, загрузился ли PDF успешно
            if (pdfViewerFrame.contentDocument && pdfViewerFrame.contentDocument.body) {
                console.log('PDF загружен успешно');
            }
        } catch (e) {
            console.log('PDF не может быть просмотрен:', e);
            // PDF не может быть просмотрен в iframe, но это нормально для PDF
        }
    };
    
    // Устанавливаем информацию о файле
    pdfFileName.textContent = fileName;
    pdfFileSize.textContent = fileSize || '';
    
    // Устанавливаем ссылку для скачивания
    downloadPdfBtn.href = `/file/${fileId}`;
    
    // Показываем модальное окно
    const pdfViewerModal = new bootstrap.Modal(document.getElementById('pdfViewerModal'));
    pdfViewerModal.show();
}

// Функция для открытия просмотрщика документов (Word, Excel, etc.)
function openDocumentViewer(fileId, fileName, fileSize) {
    const documentViewerFrame = document.getElementById('documentViewerFrame');
    const documentFileName = document.getElementById('documentFileName');
    const documentFileSize = document.getElementById('documentFileSize');
    const downloadDocumentBtn = document.getElementById('downloadDocumentBtn');
    const openDocumentBtn = document.getElementById('openDocumentBtn');
    
    // Проверяем тип документа
    const isOfficeDocument = fileName.match(/\.(doc|docx|xls|xlsx|ppt|pptx)$/i);
    const isOpenDocument = fileName.match(/\.(odt|ods|odp)$/i);
    
    if (isOfficeDocument || isOpenDocument) {
        // Для Office документов используем облачный просмотрщик
        documentViewerFrame.style.display = 'block';
        
        // Определяем тип документа для выбора подходящего просмотрщика
        let viewerUrl;
        const fileUrl = `${window.location.origin}/view/${fileId}`;
        
        // Для Office документов показываем сообщение о том, что просмотр не поддерживается
        // Эти файлы не могут быть просмотрены в браузере
        documentViewerFrame.style.display = 'none';
        const messageDiv = document.createElement('div');
        messageDiv.className = 'text-center p-4';
        messageDiv.innerHTML = `
            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
            <h5>Просмотр документа не поддерживается</h5>
            <p class="text-muted">Файл "${fileName}" не может быть просмотрен в браузере.</p>
            <p class="text-muted">Для просмотра скачайте файл и откройте его в соответствующем приложении.</p>
            <div class="mt-3">
                <a href="/file/${fileId}" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Скачать файл
                </a>
            </div>
        `;
        
        // Удаляем предыдущее сообщение, если оно есть
        const existingMessage = document.querySelector('.document-container .text-center');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        document.querySelector('.document-container').appendChild(messageDiv);
    } else {
        // Для других типов документов показываем iframe
        documentViewerFrame.style.display = 'block';
        documentViewerFrame.src = `/view/${fileId}`;
        
        // Удаляем сообщение, если оно есть
        const existingMessage = document.querySelector('.document-container .text-center');
        if (existingMessage) {
            existingMessage.remove();
        }
    }
    
    // Устанавливаем информацию о файле
    documentFileName.textContent = fileName;
    documentFileSize.textContent = fileSize || '';
    
    // Устанавливаем ссылки
    downloadDocumentBtn.href = `/file/${fileId}`;
    openDocumentBtn.href = `/file/${fileId}`;
    
    // Показываем модальное окно
    const documentViewerModal = new bootstrap.Modal(document.getElementById('documentViewerModal'));
    documentViewerModal.show();
}

// Функция для открытия просмотрщика текстовых файлов
function openTextViewer(fileId, fileName, fileSize) {
    const textViewerContent = document.getElementById('textViewerContent');
    const textFileName = document.getElementById('textFileName');
    const textFileSize = document.getElementById('textFileSize');
    const downloadTextBtn = document.getElementById('downloadTextBtn');
    
    // Загружаем содержимое текстового файла для просмотра
    fetch(`/view/${fileId}`)
        .then(response => response.text())
        .then(content => {
            textViewerContent.textContent = content;
        })
        .catch(error => {
            console.error('Ошибка загрузки текстового файла:', error);
            textViewerContent.textContent = 'Ошибка загрузки файла';
        });
    
    // Устанавливаем информацию о файле
    textFileName.textContent = fileName;
    textFileSize.textContent = fileSize || '';
    
    // Устанавливаем ссылку для скачивания
    downloadTextBtn.href = `/file/${fileId}`;
    
    // Показываем модальное окно
    const textViewerModal = new bootstrap.Modal(document.getElementById('textViewerModal'));
    textViewerModal.show();
}

// Обработчик ошибок загрузки изображения и восстановление режима просмотра
document.addEventListener('DOMContentLoaded', function() {
    // Обработчик ошибок загрузки изображения
    const imageViewerImg = document.getElementById('imageViewerImg');
    if (imageViewerImg) {
        imageViewerImg.addEventListener('error', function() {
            console.error('Ошибка загрузки изображения');
            // Можно показать сообщение об ошибке пользователю
        });
    }
    
    // Восстанавливаем выбранный режим при загрузке страницы
    const savedMode = localStorage.getItem('viewMode') || 'tile';
    console.log('Setting initial view mode:', savedMode);
    setViewMode(savedMode);
});
</script>
{% endblock %}
